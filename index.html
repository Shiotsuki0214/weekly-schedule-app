// èªè¨¼ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¡¨ç¤º
        function showAuthStatus(message, type) {
            const authStatus = document.getElementById('authStatus');
            authStatus.innerHTML = `<div class="status-message status-${type}">${message}</div>`;
        }<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é€±æ¡ˆç®¡ç†ã‚¢ãƒ—ãƒª</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Hiragino Sans', 'Yu Gothic', 'Meiryo', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            font-weight: 300;
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .main-content {
            padding: 40px;
        }

        .section {
            margin-bottom: 40px;
            background: #f8f9fa;
            border-radius: 15px;
            padding: 30px;
            border-left: 5px solid #4facfe;
        }

        .section h2 {
            color: #333;
            margin-bottom: 20px;
            font-size: 1.5rem;
            display: flex;
            align-items: center;
        }

        .section h2::before {
            content: '';
            width: 8px;
            height: 8px;
            background: #4facfe;
            border-radius: 50%;
            margin-right: 15px;
        }

        .form-group {
            margin-bottom: 25px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }

        .form-control {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 1rem;
            transition: all 0.3s ease;
            background: white;
        }

        .form-control:focus {
            outline: none;
            border-color: #4facfe;
            box-shadow: 0 0 0 3px rgba(79, 172, 254, 0.1);
        }

        .file-input-wrapper {
            position: relative;
            display: inline-block;
            cursor: pointer;
            width: 100%;
        }

        .file-input {
            opacity: 0;
            position: absolute;
            z-index: -1;
        }

        .file-input-label {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
            border: 2px dashed #4facfe;
            border-radius: 10px;
            background: rgba(79, 172, 254, 0.05);
            color: #4facfe;
            font-weight: 600;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .file-input-label:hover {
            background: rgba(79, 172, 254, 0.1);
            border-color: #0084ff;
        }

        .file-input-label.has-file {
            background: rgba(40, 167, 69, 0.1);
            border-color: #28a745;
            color: #28a745;
        }

        .btn {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 10px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            box-shadow: 0 4px 15px rgba(79, 172, 254, 0.3);
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(79, 172, 254, 0.4);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .preview-area {
            margin-top: 20px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            padding: 20px;
            background: white;
            min-height: 200px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .preview-image {
            max-width: 100%;
            max-height: 400px;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .status-message {
            padding: 15px 20px;
            border-radius: 10px;
            margin-top: 20px;
            font-weight: 600;
        }

        .status-success {
            background: rgba(40, 167, 69, 0.1);
            color: #28a745;
            border: 1px solid rgba(40, 167, 69, 0.2);
        }

        .status-error {
            background: rgba(220, 53, 69, 0.1);
            color: #dc3545;
            border: 1px solid rgba(220, 53, 69, 0.2);
        }

        .status-info {
            background: rgba(23, 162, 184, 0.1);
            color: #17a2b8;
            border: 1px solid rgba(23, 162, 184, 0.2);
        }

        .status-warning {
            background: rgba(255, 193, 7, 0.1);
            color: #856404;
            border: 1px solid rgba(255, 193, 7, 0.2);
        }

        .schedule-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .day-column {
            background: white;
            border-radius: 10px;
            padding: 20px;
            border: 2px solid #e0e0e0;
        }

        .day-header {
            font-weight: bold;
            text-align: center;
            padding: 10px;
            background: #4facfe;
            color: white;
            border-radius: 8px;
            margin-bottom: 15px;
        }

        .period-item {
            padding: 8px 12px;
            margin: 5px 0;
            background: #f8f9fa;
            border-radius: 6px;
            border-left: 3px solid #4facfe;
            font-size: 0.9rem;
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #4facfe;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .hidden {
            display: none;
        }

        .grid-2 {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .config-section {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 30px;
        }

        .config-section h3 {
            color: #856404;
            margin-bottom: 15px;
        }

        .usage-stats {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            border-radius: 10px;
            padding: 15px;
            margin-top: 20px;
        }

        @media (max-width: 768px) {
            .grid-2 {
                grid-template-columns: 1fr;
            }
            
            .header h1 {
                font-size: 2rem;
            }
            
            .main-content {
                padding: 20px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ“… é€±æ¡ˆç®¡ç†ã‚¢ãƒ—ãƒª</h1>
            <p>é€±æ¡ˆç”»åƒã‹ã‚‰Googleã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã¨ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã‚’è‡ªå‹•æ›´æ–°</p>
        </div>

        <div class="main-content">
            <!-- è¨­å®šã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
            <div class="config-section">
                <h3>âš™ï¸ åˆæœŸè¨­å®šãŒå¿…è¦ã§ã™</h3>
                <p>ã“ã®ã‚¢ãƒ—ãƒªã‚’ä½¿ç”¨ã™ã‚‹ã«ã¯ã€Google Cloud Consoleã§APIã‚­ãƒ¼ã¨ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆIDã‚’è¨­å®šã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚</p>
                <p><strong>config.js</strong> ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã—ã€ä»¥ä¸‹ã®å€¤ã‚’è¨­å®šã—ã¦ãã ã•ã„ï¼š</p>
                <pre style="background: #f8f9fa; padding: 10px; border-radius: 5px; margin: 10px 0;">
// config.js
window.APP_CONFIG = {
    CLIENT_ID: 'ã‚ãªãŸã®ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆID',
    API_KEY: 'ã‚ãªãŸã®APIã‚­ãƒ¼',
    SPREADSHEET_ID: '1RUYuKXKIKqMZ7M6B9cJnRHEsoAGqx1tkqXgBvK8jzLk'
};
                </pre>
                <div id="configStatus" class="status-message status-warning">
                    âš ï¸ è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã¾ã›ã‚“
                </div>
            </div>

            <!-- Googleèªè¨¼ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
            <div class="section">
                <h2>ğŸ” Googleèªè¨¼</h2>
                <div id="authSection">
                    <button id="authorizeBtn" class="btn" disabled>
                        ğŸ”“ Googleã‚¢ã‚«ã‚¦ãƒ³ãƒˆã§ã‚µã‚¤ãƒ³ã‚¤ãƒ³
                    </button>
                    <button id="signOutBtn" class="btn hidden" style="margin-left: 10px; background: #dc3545;">
                        ğŸšª ã‚µã‚¤ãƒ³ã‚¢ã‚¦ãƒˆ
                    </button>
                    <div id="authStatus" style="margin-top: 15px;"></div>
                </div>
                
                <!-- ä½¿ç”¨é‡çµ±è¨ˆ -->
                <div id="usageStats" class="usage-stats hidden">
                    <h4>ğŸ“Š ä»Šæ—¥ã®ä½¿ç”¨çŠ¶æ³</h4>
                    <div id="statsContent"></div>
                </div>
            </div>

            <!-- ç”»åƒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
            <div class="section">
                <h2>ğŸ“· é€±æ¡ˆç”»åƒã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</h2>
                <div class="form-group">
                    <div class="file-input-wrapper">
                        <input type="file" id="imageFile" class="file-input" accept="image/*">
                        <label for="imageFile" class="file-input-label" id="fileLabel">
                            ğŸ“ é€±æ¡ˆç”»åƒã‚’é¸æŠã—ã¦ãã ã•ã„
                        </label>
                    </div>
                </div>
                <div class="preview-area" id="previewArea">
                    <p style="color: #666;">ç”»åƒã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã™ã‚‹ã¨ã“ã“ã«ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãŒè¡¨ç¤ºã•ã‚Œã¾ã™</p>
                </div>
            </div>

            <!-- å‡¦ç†å®Ÿè¡Œã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
            <div class="section">
                <h2>âš™ï¸ å‡¦ç†å®Ÿè¡Œ</h2>
                <button id="processBtn" class="btn" disabled>
                    ğŸ“… ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã¨ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã‚’æ›´æ–°
                </button>
                <div id="statusArea"></div>
            </div>

            <!-- è§£æçµæœè¡¨ç¤ºã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
            <div class="section hidden" id="resultsSection">
                <h2>ğŸ“Š è§£æçµæœ</h2>
                <div id="schedulePreview" class="schedule-grid"></div>
            </div>
        </div>
    </div>

    <script src="https://apis.google.com/js/api.js"></script>
    <script src="https://accounts.google.com/gsi/client"></script>
    <script src="config.js"></script>
    <script>
        // ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è¨­å®š
        const SECURITY = {
            maxDailyRequests: 50,
            maxFileSize: 10 * 1024 * 1024, // 10MB
            allowedImageTypes: ['image/jpeg', 'image/png', 'image/jpg'],
            rateLimitWindow: 60000, // 1åˆ†
            maxRequestsPerWindow: 5
        };

        // ä½¿ç”¨é‡è¿½è·¡
        const usageTracker = {
            key: 'weeklyScheduleApp_usage',
            
            getTodayUsage() {
                const today = new Date().toDateString();
                const data = JSON.parse(localStorage.getItem(this.key) || '{}');
                return data[today] || { requests: 0, lastReset: Date.now() };
            },
            
            incrementUsage() {
                const today = new Date().toDateString();
                const data = JSON.parse(localStorage.getItem(this.key) || '{}');
                data[today] = { 
                    requests: (data[today]?.requests || 0) + 1, 
                    lastReset: Date.now() 
                };
                localStorage.setItem(this.key, JSON.stringify(data));
                this.updateStatsDisplay();
            },
            
            checkLimit() {
                const usage = this.getTodayUsage();
                return usage.requests < SECURITY.maxDailyRequests;
            },
            
            updateStatsDisplay() {
                const usage = this.getTodayUsage();
                const statsDiv = document.getElementById('statsContent');
                const remaining = SECURITY.maxDailyRequests - usage.requests;
                
                statsDiv.innerHTML = `
                    <p>ä»Šæ—¥ã®å‡¦ç†å›æ•°: ${usage.requests}/${SECURITY.maxDailyRequests}</p>
                    <p>æ®‹ã‚Šå‡¦ç†å¯èƒ½å›æ•°: ${remaining}</p>
                    <p style="font-size: 0.9em; color: #666;">åˆ¶é™ã¯æ—¥æœ¬æ™‚é–“ã®0æ™‚ã«ãƒªã‚»ãƒƒãƒˆã•ã‚Œã¾ã™</p>
                `;
                
                if (remaining <= 5) {
                    statsDiv.innerHTML += '<p style="color: #dc3545;">âš ï¸ æœ¬æ—¥ã®åˆ¶é™ã«è¿‘ã¥ã„ã¦ã„ã¾ã™</p>';
                }
            }
        };

        // ãƒ¬ãƒ¼ãƒˆåˆ¶é™
        const rateLimiter = {
            requests: [],
            
            canMakeRequest() {
                const now = Date.now();
                this.requests = this.requests.filter(time => now - time < SECURITY.rateLimitWindow);
                return this.requests.length < SECURITY.maxRequestsPerWindow;
            },
            
            recordRequest() {
                this.requests.push(Date.now());
            }
        };

        // ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°æƒ…å ±è¡¨ç¤º
        function showTroubleshootingInfo(error) {
            const authStatus = document.getElementById('authStatus');
            const currentDomain = window.location.origin;
            
            const troubleshootingHTML = `
                <div class="status-message status-warning" style="margin-top: 15px;">
                    <h4>ğŸ”§ ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°</h4>
                    <p><strong>ç¾åœ¨ã®ãƒ‰ãƒ¡ã‚¤ãƒ³:</strong> ${currentDomain}</p>
                    <p><strong>ã‚ˆãã‚ã‚‹è§£æ±ºæ–¹æ³•:</strong></p>
                    <ol style="margin: 10px 0; padding-left: 20px;">
                        <li><strong>config.js ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç¢ºèª:</strong><br>
                            - CLIENT_ID ãŒæ­£ã—ãè¨­å®šã•ã‚Œã¦ã„ã‚‹ã‹<br>
                            - API_KEY ãŒæ­£ã—ãè¨­å®šã•ã‚Œã¦ã„ã‚‹ã‹
                        </li>
                        <li><strong>Google Cloud Console ã®è¨­å®š:</strong><br>
                            - æ‰¿èªæ¸ˆã¿JavaScriptç”Ÿæˆå…ƒã« <code>${currentDomain}</code> ã‚’è¿½åŠ <br>
                            - HTTPãƒªãƒ•ã‚¡ãƒ©ãƒ¼åˆ¶é™ã« <code>${currentDomain}/*</code> ã‚’è¿½åŠ 
                        </li>
                        <li><strong>API ã®æœ‰åŠ¹åŒ–:</strong><br>
                            - Google Calendar API ãŒæœ‰åŠ¹ã«ãªã£ã¦ã„ã‚‹ã‹<br>
                            - Google Sheets API ãŒæœ‰åŠ¹ã«ãªã£ã¦ã„ã‚‹ã‹
                        </li>
                        <li><strong>ãƒ–ãƒ©ã‚¦ã‚¶ã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ã‚¯ãƒªã‚¢</strong></li>
                    </ol>
                    <p style="margin-top: 10px;">
                        <a href="https://console.cloud.google.com/apis/credentials" target="_blank" style="color: #007bff;">
                            ğŸ”— Google Cloud Console ã§è¨­å®šã‚’ç¢ºèª
                        </a>
                    </p>
                </div>
            `;
            
            authStatus.innerHTML += troubleshootingHTML;
        }

        // è¨­å®šãƒã‚§ãƒƒã‚¯
        function checkConfig() {
            const configDiv = document.getElementById('configStatus');
            
            if (!window.APP_CONFIG) {
                configDiv.innerHTML = `
                    <div class="status-message status-error">
                        âŒ config.js ãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“<br>
                        <small>åŒã˜ãƒ•ã‚©ãƒ«ãƒ€ã« config.js ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã—ã¦ãã ã•ã„</small>
                    </div>
                `;
                return false;
            }
            
            const config = window.APP_CONFIG;
            const issues = [];
            
            if (!config.CLIENT_ID || config.CLIENT_ID === 'ã‚ãªãŸã®ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆID') {
                issues.push('CLIENT_ID ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“');
            }
            
            if (!config.API_KEY || config.API_KEY === 'ã‚ãªãŸã®APIã‚­ãƒ¼') {
                issues.push('API_KEY ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“');
            }
            
            if (!config.SPREADSHEET_ID) {
                issues.push('SPREADSHEET_ID ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“');
            }
            
            // ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆãƒã‚§ãƒƒã‚¯
            if (config.CLIENT_ID && !config.CLIENT_ID.includes('.apps.googleusercontent.com')) {
                issues.push('CLIENT_ID ã®å½¢å¼ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“');
            }
            
            if (config.API_KEY && !config.API_KEY.startsWith('AIza')) {
                issues.push('API_KEY ã®å½¢å¼ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“');
            }
            
            if (issues.length > 0) {
                configDiv.innerHTML = `
                    <div class="status-message status-error">
                        âŒ è¨­å®šã«å•é¡ŒãŒã‚ã‚Šã¾ã™:<br>
                        ${issues.map(issue => `â€¢ ${issue}`).join('<br>')}
                        <br><br>
                        <strong>config.js ã®æ­£ã—ã„ä¾‹:</strong>
                        <pre style="background: #f8f9fa; padding: 10px; border-radius: 5px; margin: 10px 0; font-size: 0.9em;">
window.APP_CONFIG = {
    CLIENT_ID: '123456789-xxxxx.apps.googleusercontent.com',
    API_KEY: 'AIzaSyDxxxxxxxxxxxxxxxxxxxxxxxxxxxxx',
    SPREADSHEET_ID: '1RUYuKXKIKqMZ7M6B9cJnRHEsoAGqx1tkqXgBvK8jzLk'
};
                        </pre>
                    </div>
                `;
                return false;
            }
            
            APP_CONFIG = config;
            configDiv.innerHTML = `
                <div class="status-message status-success">
                    âœ… è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ãŒæ­£å¸¸ã«èª­ã¿è¾¼ã¾ã‚Œã¾ã—ãŸ<br>
                    <small>Client ID: ${config.CLIENT_ID.substring(0, 15)}...</small><br>
                    <small>API Key: ${config.API_KEY.substring(0, 15)}...</small>
                </div>
            `;
            return true;
        }

        // ãƒ•ã‚¡ã‚¤ãƒ«æ¤œè¨¼
        function validateFile(file) {
            if (!file) return { valid: false, error: 'ãƒ•ã‚¡ã‚¤ãƒ«ãŒé¸æŠã•ã‚Œã¦ã„ã¾ã›ã‚“' };
            
            if (file.size > SECURITY.maxFileSize) {
                return { valid: false, error: 'ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºãŒå¤§ãã™ãã¾ã™ï¼ˆæœ€å¤§10MBï¼‰' };
            }
            
            if (!SECURITY.allowedImageTypes.includes(file.type)) {
                return { valid: false, error: 'å¯¾å¿œã—ã¦ã„ãªã„ãƒ•ã‚¡ã‚¤ãƒ«å½¢å¼ã§ã™ï¼ˆJPEG, PNGã®ã¿ï¼‰' };
            }
            
            return { valid: true };
        }

        // CSVãƒ‡ãƒ¼ã‚¿ï¼ˆåŸ‹ã‚è¾¼ã¿ï¼‰
        const csvData = `Subject,æ›œæ—¥,é–‹å§‹æ™‚åˆ»,çµ‚äº†æ™‚åˆ»
èª­æ›¸ã‚¿ã‚¤ãƒ ,æœˆ,8:10,8:25
1æ™‚é–“ç›®,æœˆ,8:40,9:25
2æ™‚é–“ç›®,æœˆ,9:30,10:15
ä¸­ä¼‘ã¿,æœˆ,10:15,10:35
3æ™‚é–“ç›®,æœˆ,10:35,11:20
4æ™‚é–“ç›®,æœˆ,11:25,12:10
çµ¦é£Ÿ,æœˆ,12:10,12:50
æ˜¼ä¼‘ã¿,æœˆ,12:50,13:20
5æ™‚é–“ç›®,æœˆ,13:25,14:10
6æ™‚é–“ç›®,æœˆ,14:15,15:00
å¸°ã‚Šã®ä¼š,æœˆ,15:00,15:15
è·å“¡ä¼šè­°ãƒ»ã‚±ãƒ¼ã‚¹ä¼šè­°,æœˆ,15:30,16:40
å­¦ã³å­ï¼ˆç®—æ•°ï¼‰,ç«,8:10,8:25
1æ™‚é–“ç›®,ç«,8:40,9:25
2æ™‚é–“ç›®,ç«,9:30,10:15
ä¸­ä¼‘ã¿,ç«,10:15,10:35
3æ™‚é–“ç›®,ç«,10:35,11:20
4æ™‚é–“ç›®,ç«,11:25,12:10
çµ¦é£Ÿ,ç«,12:10,12:50
æ˜¼ä¼‘ã¿,ç«,12:50,13:20
æ¸…æƒ,ç«,13:25,13:45
5æ™‚é–“ç›®,ç«,13:45,14:30
6æ™‚é–“ç›®,ç«,14:35,15:20
å¸°ã‚Šã®ä¼š,ç«,15:20,15:35
å­¦å¹´ä¼š,ç«,16:00,16:40
ãƒ•ãƒƒåŒ–ç‰©æ´—å£,æ°´,8:10,8:25
1æ™‚é–“ç›®,æ°´,8:40,9:25
2æ™‚é–“ç›®,æ°´,9:30,10:15
ä¸­ä¼‘ã¿,æ°´,10:15,10:35
3æ™‚é–“ç›®,æ°´,10:35,11:20
4æ™‚é–“ç›®,æ°´,11:25,12:10
çµ¦é£Ÿ,æ°´,12:10,12:50
æ˜¼ä¼‘ã¿,æ°´,12:50,13:20
æ¸…æƒ,æ°´,13:25,13:45
5æ™‚é–“ç›®,æ°´,13:45,14:30
å¸°ã‚Šã®ä¼š,æ°´,14:30,14:45
æ ¡å†…ç ”ä¿®,æ°´,15:15,16:40
å…¨æ ¡ã‚¿ã‚¤ãƒ ,æœ¨,8:10,8:25
1æ™‚é–“ç›®,æœ¨,8:40,9:25
2æ™‚é–“ç›®,æœ¨,9:30,10:15
ä¸­ä¼‘ã¿,æœ¨,10:15,10:35
3æ™‚é–“ç›®,æœ¨,10:35,11:20
4æ™‚é–“ç›®,æœ¨,11:25,12:10
çµ¦é£Ÿ,æœ¨,12:10,12:50
æ˜¼ä¼‘ã¿,æœ¨,12:50,13:20
æ¸…æƒ,æœ¨,13:25,13:45
5æ™‚é–“ç›®,æœ¨,13:45,14:30
6æ™‚é–“ç›®,æœ¨,14:35,15:20
å¸°ã‚Šã®ä¼š,æœ¨,15:20,15:35
ãƒãƒ£ãƒ¬ãƒ³ã‚¸,æœ¨,15:50,16:40
1å¹´ç”Ÿ,é‡‘,8:10,8:25
1æ™‚é–“ç›®,é‡‘,8:40,9:25
2æ™‚é–“ç›®,é‡‘,9:30,10:15
ä¸­ä¼‘ã¿,é‡‘,10:15,10:35
3æ™‚é–“ç›®,é‡‘,10:35,11:20
4æ™‚é–“ç›®,é‡‘,11:25,12:10
çµ¦é£Ÿ,é‡‘,12:10,12:50
æ˜¼ä¼‘ã¿,é‡‘,12:50,13:20
æ¸…æƒ,é‡‘,13:25,13:45
5æ™‚é–“ç›®,é‡‘,13:45,14:30
6æ™‚é–“ç›®,é‡‘,14:35,15:20
å¸°ã‚Šã®ä¼š,é‡‘,15:20,15:35
å¤–éƒ¨è¬›å¸«,é‡‘,15:35,17:05`;

        // æ™‚ç¨‹è¡¨ãƒ‡ãƒ¼ã‚¿ã®è§£æ
        function loadTimeSlots() {
            try {
                const lines = csvData.trim().split('\n');
                const headers = lines[0].split(',');
                
                timeSlots = lines.slice(1).map(line => {
                    const values = line.split(',');
                    const obj = {};
                    headers.forEach((header, index) => {
                        obj[header] = values[index];
                    });
                    return obj;
                });
                
                console.log('æ™‚ç¨‹è¡¨ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ:', timeSlots);
                showStatus('ğŸ“š æ™‚ç¨‹è¡¨ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿å®Œäº†', 'success');
                return true;
            } catch (error) {
                console.error('æ™‚ç¨‹è¡¨ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
                showStatus('æ™‚ç¨‹è¡¨ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
                return false;
            }
        }

        // Google APIåˆæœŸåŒ–ï¼ˆæ–°ã—ã„GISãƒ©ã‚¤ãƒ–ãƒ©ãƒªä½¿ç”¨ï¼‰
        async function initializeGapi() {
            if (!APP_CONFIG) {
                showAuthStatus('âŒ è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã‚“ã§ãã ã•ã„', 'error');
                return;
            }

            try {
                showAuthStatus('ğŸ”„ Google APIã‚’åˆæœŸåŒ–ä¸­...', 'info');
                
                // 1. GAPI ClientåˆæœŸåŒ–
                await new Promise((resolve, reject) => {
                    gapi.load('client', {
                        callback: resolve,
                        onerror: () => reject(new Error('GAPI ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®èª­ã¿è¾¼ã¿ã«å¤±æ•—'))
                    });
                });

                // 2. API Clientè¨­å®š
                await gapi.client.init({
                    apiKey: APP_CONFIG.API_KEY,
                    discoveryDocs: [
                        'https://www.googleapis.com/discovery/v1/apis/calendar/v3/rest',
                        'https://sheets.googleapis.com/$discovery/rest?version=v4'
                    ]
                });

                console.log('GAPI ClientåˆæœŸåŒ–å®Œäº†');

                // 3. Google Identity Services (GIS) Token ClientåˆæœŸåŒ–
                tokenClient = google.accounts.oauth2.initTokenClient({
                    client_id: APP_CONFIG.CLIENT_ID,
                    scope: 'https://www.googleapis.com/auth/calendar https://www.googleapis.com/auth/spreadsheets',
                    callback: (response) => {
                        if (response.error) {
                            console.error('èªè¨¼ã‚¨ãƒ©ãƒ¼:', response.error);
                            showAuthStatus('âŒ èªè¨¼ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
                            isSignedIn = false;
                        } else {
                            console.log('èªè¨¼æˆåŠŸ:', response);
                            accessToken = response.access_token;
                            gapi.client.setToken({access_token: accessToken});
                            isSignedIn = true;
                            showAuthStatus('âœ… Googleèªè¨¼ãŒå®Œäº†ã—ã¾ã—ãŸ', 'success');
                        }
                        updateAuthStatus();
                    }
                });

                console.log('Google Identity ServicesåˆæœŸåŒ–å®Œäº†');
                showAuthStatus('âœ… Google APIåˆæœŸåŒ–å®Œäº†ã€‚ã‚µã‚¤ãƒ³ã‚¤ãƒ³ã—ã¦ãã ã•ã„ã€‚', 'success');
                updateAuthStatus();
                
            } catch (error) {
                console.error('Google APIåˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼:', error);
                
                let errorMessage = 'âŒ Google APIåˆæœŸåŒ–ã«å¤±æ•—ã—ã¾ã—ãŸ: ';
                
                if (error.message.includes('API key')) {
                    errorMessage += 'APIã‚­ãƒ¼ãŒç„¡åŠ¹ã§ã™ã€‚';
                } else if (error.message.includes('Client ID')) {
                    errorMessage += 'ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆIDãŒç„¡åŠ¹ã§ã™ã€‚';
                } else if (error.message.includes('origin')) {
                    errorMessage += 'ãƒ‰ãƒ¡ã‚¤ãƒ³ãŒè¨±å¯ãƒªã‚¹ãƒˆã«ç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚';
                } else {
                    errorMessage += error.message;
                }
                
                showAuthStatus(errorMessage, 'error');
                showTroubleshootingInfo(error);
            }
        }

        // èªè¨¼çŠ¶æ…‹æ›´æ–°ï¼ˆæ–°ã—ã„GISå¯¾å¿œï¼‰
        function updateAuthStatus() {
            const authorizeBtn = document.getElementById('authorizeBtn');
            const usageStatsDiv = document.getElementById('usageStats');
            
            if (isSignedIn && accessToken) {
                authorizeBtn.textContent = `âœ… ã‚µã‚¤ãƒ³ã‚¤ãƒ³æ¸ˆã¿`;
                authorizeBtn.disabled = true;
                showAuthStatus('âœ… Googleèªè¨¼ãŒå®Œäº†ã—ã¾ã—ãŸã€‚', 'success');
                
                usageStatsDiv.classList.remove('hidden');
                usageTracker.updateStatsDisplay();
            } else {
                authorizeBtn.textContent = 'ğŸ”“ Googleã‚¢ã‚«ã‚¦ãƒ³ãƒˆã§ã‚µã‚¤ãƒ³ã‚¤ãƒ³';
                authorizeBtn.disabled = false;
                showAuthStatus('âš ï¸ Googleèªè¨¼ãŒå¿…è¦ã§ã™', 'info');
                usageStatsDiv.classList.add('hidden');
            }
            
            checkFormCompletion();
        }

        // ã‚µã‚¤ãƒ³ã‚¤ãƒ³å‡¦ç†ï¼ˆæ–°ã—ã„GISä½¿ç”¨ï¼‰
        function signIn() {
            if (!tokenClient) {
                showAuthStatus('âŒ èªè¨¼ã‚·ã‚¹ãƒ†ãƒ ãŒåˆæœŸåŒ–ã•ã‚Œã¦ã„ã¾ã›ã‚“', 'error');
                return;
            }

            try {
                // æ—¢å­˜ã®ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ã‚¯ãƒªã‚¢
                if (accessToken) {
                    google.accounts.oauth2.revoke(accessToken, () => {
                        console.log('æ—¢å­˜ã®ãƒˆãƒ¼ã‚¯ãƒ³ã‚’å–ã‚Šæ¶ˆã—ã¾ã—ãŸ');
                    });
                }
                
                // æ–°ã—ã„èªè¨¼ã‚’é–‹å§‹
                tokenClient.requestAccessToken({prompt: 'consent'});
            } catch (error) {
                console.error('ã‚µã‚¤ãƒ³ã‚¤ãƒ³ã‚¨ãƒ©ãƒ¼:', error);
                showAuthStatus('âŒ ã‚µã‚¤ãƒ³ã‚¤ãƒ³ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
            }
        }

        // ã‚µã‚¤ãƒ³ã‚¢ã‚¦ãƒˆå‡¦ç†
        function signOut() {
            if (accessToken) {
                google.accounts.oauth2.revoke(accessToken, () => {
                    console.log('ãƒˆãƒ¼ã‚¯ãƒ³ã‚’å–ã‚Šæ¶ˆã—ã¾ã—ãŸ');
                });
                gapi.client.setToken(null);
                accessToken = null;
                isSignedIn = false;
                updateAuthStatus();
                showAuthStatus('âœ… ã‚µã‚¤ãƒ³ã‚¢ã‚¦ãƒˆã—ã¾ã—ãŸ', 'info');
            }
        }

        // ãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å‡¦ç†
        document.getElementById('imageFile').addEventListener('change', function(e) {
            const file = e.target.files[0];
            const label = document.getElementById('fileLabel');
            const previewArea = document.getElementById('previewArea');

            if (file) {
                const validation = validateFile(file);
                if (!validation.valid) {
                    showStatus(`âŒ ${validation.error}`, 'error');
                    this.value = '';
                    return;
                }

                label.textContent = `âœ… ${file.name} (${(file.size / 1024 / 1024).toFixed(1)}MB)`;
                label.classList.add('has-file');
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    previewArea.innerHTML = `<img src="${e.target.result}" class="preview-image" alt="é€±æ¡ˆãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼">`;
                };
                reader.onerror = function() {
                    showStatus('âŒ ç”»åƒã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
                };
                reader.readAsDataURL(file);
                
                checkFormCompletion();
                showStatus('âœ… ç”»åƒãŒæ­£å¸¸ã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã•ã‚Œã¾ã—ãŸ', 'success');
            } else {
                label.textContent = 'ğŸ“ é€±æ¡ˆç”»åƒã‚’é¸æŠã—ã¦ãã ã•ã„';
                label.classList.remove('has-file');
                previewArea.innerHTML = '<p style="color: #666;">ç”»åƒã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã™ã‚‹ã¨ã“ã“ã«ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãŒè¡¨ç¤ºã•ã‚Œã¾ã™</p>';
                checkFormCompletion();
            }
        });

        // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤º
        function showStatus(message, type = 'info') {
            const statusArea = document.getElementById('statusArea');
            statusArea.innerHTML = `<div class="status-message status-${type}">${message}</div>`;
        }

        // ç”»åƒè§£æï¼ˆæ¨¡æ“¬å®Ÿè£…ï¼‰
        async function analyzeScheduleImage(imageFile) {
            showStatus('ğŸ” ç”»åƒã‚’è§£æä¸­...', 'info');
            
            const mockSchedule = {
                'æœˆ': {
                    '1æ™‚é–“ç›®': 'å›½èª',
                    '2æ™‚é–“ç›®': 'ç®—æ•°',
                    '3æ™‚é–“ç›®': 'ç·åˆ',
                    '4æ™‚é–“ç›®': 'ç†ç§‘',
                    '5æ™‚é–“ç›®': 'å›³å·¥',
                    '6æ™‚é–“ç›®': 'å›³å·¥'
                },
                'ç«': {
                    '1æ™‚é–“ç›®': 'ç®—æ•°',
                    '2æ™‚é–“ç›®': 'å›½èª',
                    '3æ™‚é–“ç›®': 'ç¤¾ä¼š',
                    '4æ™‚é–“ç›®': 'ä½“è‚²',
                    '5æ™‚é–“ç›®': 'ç†ç§‘',
                    '6æ™‚é–“ç›®': 'å§”å“¡ä¼šæ´»å‹•'
                },
                'æ°´': {
                    '1æ™‚é–“ç›®': 'ç‰¹æ´»',
                    '2æ™‚é–“ç›®': 'å›½èª',
                    '3æ™‚é–“ç›®': 'ç®—æ•°',
                    '4æ™‚é–“ç›®': 'å¤–å›½èª',
                    '5æ™‚é–“ç›®': 'ç¤¾ä¼š'
                },
                'æœ¨': {
                    '1æ™‚é–“ç›®': 'ç®—æ•°',
                    '2æ™‚é–“ç›®': 'æ›¸å†™',
                    '3æ™‚é–“ç›®': 'ç¤¾ä¼š',
                    '4æ™‚é–“ç›®': 'å¤–å›½èªï¼ˆALTï¼‰',
                    '5æ™‚é–“ç›®': 'éŸ³æ¥½',
                    '6æ™‚é–“ç›®': 'ç·åˆ'
                },
                'é‡‘': {
                    '1æ™‚é–“ç›®': 'å›½èª',
                    '2æ™‚é–“ç›®': 'ç®—æ•°',
                    '3æ™‚é–“ç›®': 'å®¶åº­',
                    '4æ™‚é–“ç›®': 'ç†ç§‘',
                    '5æ™‚é–“ç›®': 'ç·åˆ',
                    '6æ™‚é–“ç›®': 'ç·åˆ'
                }
            };

            await new Promise(resolve => setTimeout(resolve, 2000));
            return mockSchedule;
        }

        // æ™‚é–“ã‚’24æ™‚é–“å½¢å¼ã«å¤‰æ›
        function parseTime(timeStr) {
            const [hours, minutes] = timeStr.split(':').map(Number);
            return { hours, minutes };
        }

        // æ—¥ä»˜ã¨æ™‚åˆ»ã‹ã‚‰Dateã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ä½œæˆ
        function createDateTime(baseDate, timeStr) {
            const { hours, minutes } = parseTime(timeStr);
            const date = new Date(baseDate);
            date.setHours(hours, minutes, 0, 0);
            return date;
        }

        // Googleã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚¤ãƒ™ãƒ³ãƒˆä½œæˆ
        async function createCalendarEvent(title, startDate, endDate, description = '') {
            try {
                const event = {
                    summary: title,
                    start: {
                        dateTime: startDate.toISOString(),
                        timeZone: 'Asia/Tokyo'
                    },
                    end: {
                        dateTime: endDate.toISOString(),
                        timeZone: 'Asia/Tokyo'
                    },
                    description: description
                };

                const response = await gapi.client.calendar.events.insert({
                    calendarId: 'primary',
                    resource: event
                });

                return response.result;
            } catch (error) {
                console.error('ã‚¤ãƒ™ãƒ³ãƒˆä½œæˆã‚¨ãƒ©ãƒ¼:', error);
                throw error;
            }
        }

        // ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆæ›´æ–°
        async function updateSpreadsheet(scheduleData, startDate) {
            try {
                showStatus('ğŸ“Š ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã‚’æ›´æ–°ä¸­...', 'info');
                
                // æ•™ç§‘åˆ¥æ™‚é–“æ•°ã‚’é›†è¨ˆ
                const subjectCounts = {};
                const days = ['æœˆ', 'ç«', 'æ°´', 'æœ¨', 'é‡‘'];
                
                days.forEach(day => {
                    if (scheduleData[day]) {
                        Object.values(scheduleData[day]).forEach(subject => {
                            if (subject && subject !== 'ï¼') {
                                subjectCounts[subject] = (subjectCounts[subject] || 0) + 1;
                            }
                        });
                    }
                });

                console.log('æ•™ç§‘åˆ¥æ™‚é–“æ•°:', subjectCounts);

                // ãƒ‡ãƒ¼ã‚¿ã‚·ãƒ¼ãƒˆã«æ™‚é–“æ•°ã‚’è¨˜éŒ²
                const dataValues = [];
                Object.entries(subjectCounts).forEach(([subject, count]) => {
                    dataValues.push([new Date().toISOString().split('T')[0], subject, count]);
                });

                if (dataValues.length > 0) {
                    await gapi.client.sheets.spreadsheets.values.append({
                        spreadsheetId: APP_CONFIG.SPREADSHEET_ID,
                        range: 'ãƒ‡ãƒ¼ã‚¿!A:C',
                        valueInputOption: 'RAW',
                        resource: {
                            values: dataValues
                        }
                    });
                }

                // é€±æ¡ˆã‚·ãƒ¼ãƒˆã«é€±æ¡ˆãƒ‡ãƒ¼ã‚¿ã‚’è¨˜éŒ²
                const monday = new Date(startDate);
                const weekValues = [];
                
                // ãƒ˜ãƒƒãƒ€ãƒ¼è¡Œï¼ˆæ—¥ä»˜ï¼‰
                const dateRow = ['æ™‚é–“'];
                for (let i = 0; i < 5; i++) {
                    const date = new Date(monday);
                    date.setDate(monday.getDate() + i);
                    dateRow.push(`${date.getMonth() + 1}/${date.getDate()}(${days[i]})`);
                }
                weekValues.push(dateRow);

                // å„æ™‚é–“ç›®ã®ãƒ‡ãƒ¼ã‚¿
                const periods = ['1æ™‚é–“ç›®', '2æ™‚é–“ç›®', '3æ™‚é–“ç›®', '4æ™‚é–“ç›®', '5æ™‚é–“ç›®', '6æ™‚é–“ç›®'];
                periods.forEach(period => {
                    const row = [period];
                    days.forEach(day => {
                        const subject = scheduleData[day] && scheduleData[day][period] ? scheduleData[day][period] : '';
                        row.push(subject);
                    });
                    weekValues.push(row);
                });

                // é€±æ¡ˆã‚·ãƒ¼ãƒˆã‚’æ›´æ–°
                await gapi.client.sheets.spreadsheets.values.update({
                    spreadsheetId: APP_CONFIG.SPREADSHEET_ID,
                    range: 'é€±æ¡ˆ!A1:F7',
                    valueInputOption: 'RAW',
                    resource: {
                        values: weekValues
                    }
                });

                console.log('ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆæ›´æ–°å®Œäº†');
                return subjectCounts;
            } catch (error) {
                console.error('ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆæ›´æ–°ã‚¨ãƒ©ãƒ¼:', error);
                throw error;
            }
        }

        // ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚¤ãƒ™ãƒ³ãƒˆä½œæˆ
        async function createCalendarEvents(scheduleData, startDateStr) {
            const events = [];
            const startDate = new Date(startDateStr);
            const days = ['æœˆ', 'ç«', 'æ°´', 'æœ¨', 'é‡‘'];
            
            for (let dayIndex = 0; dayIndex < days.length; dayIndex++) {
                const day = days[dayIndex];
                const currentDate = new Date(startDate);
                currentDate.setDate(startDate.getDate() + dayIndex);
                
                if (scheduleData[day]) {
                    const dayTimeSlots = timeSlots.filter(slot => slot.æ›œæ—¥ === day);
                    
                    for (const [period, subject] of Object.entries(scheduleData[day])) {
                        if (subject && subject !== 'ï¼') {
                            const timeSlot = dayTimeSlots.find(slot => slot.Subject === period);
                            
                            if (timeSlot) {
                                const startTime = createDateTime(currentDate, timeSlot.é–‹å§‹æ™‚åˆ»);
                                const endTime = createDateTime(currentDate, timeSlot.çµ‚äº†æ™‚åˆ»);
                                
                                try {
                                    const event = await createCalendarEvent(
                                        subject,
                                        startTime,
                                        endTime,
                                        `${day}æ›œæ—¥ ${period}`
                                    );
                                    events.push(event);
                                    
                                    // APIåˆ¶é™ã‚’é¿ã‘ã‚‹ãŸã‚ã®å¾…æ©Ÿ
                                    await new Promise(resolve => setTimeout(resolve, 100));
                                } catch (error) {
                                    console.error(`ã‚¤ãƒ™ãƒ³ãƒˆä½œæˆå¤±æ•—: ${subject}`, error);
                                }
                            }
                        }
                    }
                }
            }
            
            console.log(`${events.length}ä»¶ã®ã‚¤ãƒ™ãƒ³ãƒˆã‚’ä½œæˆã—ã¾ã—ãŸ`);
            return events;
        }

        // å‡¦ç†å®Ÿè¡Œ
        document.getElementById('processBtn').addEventListener('click', async function() {
            const imageFileInput = document.getElementById('imageFile');
            const imageFile = imageFileInput.files[0];

            // ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒã‚§ãƒƒã‚¯
            if (!isSignedIn) {
                showStatus('âŒ Googleã‚¢ã‚«ã‚¦ãƒ³ãƒˆã§ã‚µã‚¤ãƒ³ã‚¤ãƒ³ã—ã¦ãã ã•ã„', 'error');
                return;
            }

            if (!usageTracker.checkLimit()) {
                showStatus('âŒ æœ¬æ—¥ã®å‡¦ç†å›æ•°åˆ¶é™ã«é”ã—ã¾ã—ãŸã€‚æ˜æ—¥å†åº¦ãŠè©¦ã—ãã ã•ã„ã€‚', 'error');
                return;
            }

            if (!rateLimiter.canMakeRequest()) {
                showStatus('âŒ å‡¦ç†ãŒé›†ä¸­ã—ã¦ã„ã¾ã™ã€‚1åˆ†å¾Œã«å†åº¦ãŠè©¦ã—ãã ã•ã„ã€‚', 'error');
                return;
            }

            const validation = validateFile(imageFile);
            if (!validation.valid) {
                showStatus(`âŒ ${validation.error}`, 'error');
                return;
            }

            if (!timeSlots || timeSlots.length === 0) {
                showStatus('âŒ æ™‚ç¨‹è¡¨ãƒ‡ãƒ¼ã‚¿ãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã¾ã›ã‚“', 'error');
                return;
            }

            try {
                // ãƒ¬ãƒ¼ãƒˆåˆ¶é™è¨˜éŒ²
                rateLimiter.recordRequest();
                
                this.innerHTML = '<span class="loading"></span>å‡¦ç†ä¸­...';
                this.disabled = true;

                // 1. ç”»åƒè§£æ
                scheduleData = await analyzeScheduleImage(imageFile);
                
                // 2. è§£æçµæœè¡¨ç¤º
                displaySchedulePreview(scheduleData);
                
                // 3. ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚¤ãƒ™ãƒ³ãƒˆä½œæˆ
                const today = new Date();
                const monday = new Date(today);
                const day = today.getDay();
                const diff = today.getDate() - day + (day === 0 ? -6 : 1);
                monday.setDate(diff);
                const startDateStr = monday.toISOString().split('T')[0];
                
                showStatus('ğŸ“… Googleã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã«äºˆå®šã‚’è¿½åŠ ä¸­...', 'info');
                const events = await createCalendarEvents(scheduleData, startDateStr);
                
                // 4. ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆæ›´æ–°
                const subjectCounts = await updateSpreadsheet(scheduleData, startDateStr);
                
                // ä½¿ç”¨é‡ã‚’è¨˜éŒ²
                usageTracker.incrementUsage();
                
                showStatus(`âœ… å‡¦ç†ãŒå®Œäº†ã—ã¾ã—ãŸï¼ ${events.length}ä»¶ã®ã‚¤ãƒ™ãƒ³ãƒˆã‚’ä½œæˆã—ã€ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã‚’æ›´æ–°ã—ã¾ã—ãŸã€‚`, 'success');
                
            } catch (error) {
                console.error('å‡¦ç†ã‚¨ãƒ©ãƒ¼:', error);
                
                let errorMessage = 'å‡¦ç†ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚';
                if (error.status === 403) {
                    errorMessage = 'Google APIã®æ¨©é™ãŒä¸è¶³ã—ã¦ã„ã¾ã™ã€‚ç®¡ç†è€…ã«ãŠå•ã„åˆã‚ã›ãã ã•ã„ã€‚';
                } else if (error.status === 429) {
                    errorMessage = 'APIã®ä½¿ç”¨é‡åˆ¶é™ã«é”ã—ã¾ã—ãŸã€‚ã—ã°ã‚‰ãæ™‚é–“ã‚’ãŠã„ã¦å†åº¦ãŠè©¦ã—ãã ã•ã„ã€‚';
                } else if (error.status === 401) {
                    errorMessage = 'èªè¨¼ãŒç„¡åŠ¹ã«ãªã‚Šã¾ã—ãŸã€‚å†åº¦ã‚µã‚¤ãƒ³ã‚¤ãƒ³ã—ã¦ãã ã•ã„ã€‚';
                }
                
                showStatus(`âŒ ${errorMessage}`, 'error');
            } finally {
                this.innerHTML = 'ğŸ“… ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã¨ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã‚’æ›´æ–°';
                this.disabled = false;
            }
        });

        // ãƒ•ã‚©ãƒ¼ãƒ å®Œäº†ãƒã‚§ãƒƒã‚¯
        function checkFormCompletion() {
            const imageFile = document.getElementById('imageFile').files[0];
            const processBtn = document.getElementById('processBtn');

            const hasValidFile = imageFile && validateFile(imageFile).valid;
            const isComplete = hasValidFile && timeSlots && timeSlots.length > 0 && isSignedIn && APP_CONFIG;
            processBtn.disabled = !isComplete;

            console.log('ãƒ•ã‚©ãƒ¼ãƒ å®Œäº†ãƒã‚§ãƒƒã‚¯:', {
                hasValidFile: hasValidFile,
                timeSlots: !!(timeSlots && timeSlots.length > 0),
                isSignedIn: isSignedIn,
                hasConfig: !!APP_CONFIG,
                isComplete: isComplete
            });
        }

        // è§£æçµæœè¡¨ç¤º
        function displaySchedulePreview(scheduleData) {
            const resultsSection = document.getElementById('resultsSection');
            const schedulePreview = document.getElementById('schedulePreview');
            
            const days = ['æœˆ', 'ç«', 'æ°´', 'æœ¨', 'é‡‘'];
            const dayNames = ['æœˆæ›œæ—¥', 'ç«æ›œæ—¥', 'æ°´æ›œæ—¥', 'æœ¨æ›œæ—¥', 'é‡‘æ›œæ—¥'];
            
            schedulePreview.innerHTML = '';
            
            days.forEach((day, index) => {
                const dayColumn = document.createElement('div');
                dayColumn.className = 'day-column';
                
                const dayHeader = document.createElement('div');
                dayHeader.className = 'day-header';
                dayHeader.textContent = dayNames[index];
                dayColumn.appendChild(dayHeader);
                
                if (scheduleData[day]) {
                    Object.entries(scheduleData[day]).forEach(([period, subject]) => {
                        const periodItem = document.createElement('div');
                        periodItem.className = 'period-item';
                        periodItem.innerHTML = `<strong>${period}:</strong> ${subject || 'ï¼'}`;
                        dayColumn.appendChild(periodItem);
                    });
                } else {
                    const noData = document.createElement('div');
                    noData.className = 'period-item';
                    noData.style.color = '#999';
                    noData.textContent = 'ãƒ‡ãƒ¼ã‚¿ãªã—';
                    dayColumn.appendChild(noData);
                }
                
                schedulePreview.appendChild(dayColumn);
            });
            
            resultsSection.classList.remove('hidden');
        }

        // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã®åˆæœŸåŒ–
        document.addEventListener('DOMContentLoaded', function() {
            console.log('ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³åˆæœŸåŒ–é–‹å§‹');
            
            // 1. è¨­å®šãƒã‚§ãƒƒã‚¯
            if (!checkConfig()) {
                console.log('è¨­å®šãƒã‚§ãƒƒã‚¯å¤±æ•—');
                return;
            }
            console.log('è¨­å®šãƒã‚§ãƒƒã‚¯å®Œäº†');
            
            // 2. æ™‚ç¨‹è¡¨ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿
            if (!loadTimeSlots()) {
                console.log('æ™‚ç¨‹è¡¨ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿å¤±æ•—');
                return;
            }
            console.log('æ™‚ç¨‹è¡¨ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿å®Œäº†');
            
            // 3. Google APIåˆæœŸåŒ–ï¼ˆGAPIã¨GISãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®èª­ã¿è¾¼ã¿å®Œäº†ã‚’å¾…ã¤ï¼‰
            setTimeout(() => {
                if (typeof gapi !== 'undefined' && typeof google !== 'undefined' && google.accounts) {
                    console.log('Google APIåˆæœŸåŒ–é–‹å§‹');
                    initializeGapi();
                } else {
                    console.error('Google API ãƒ©ã‚¤ãƒ–ãƒ©ãƒªãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã¾ã›ã‚“');
                    showAuthStatus('âŒ Google API ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿ã—ã¦ãã ã•ã„ã€‚', 'error');
                }
            }, 1000);
            
            // 4. åˆæœŸçŠ¶æ…‹ã§ãƒ•ã‚©ãƒ¼ãƒ å®Œäº†ãƒã‚§ãƒƒã‚¯
            setTimeout(checkFormCompletion, 1500);
        });

        // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
        document.getElementById('authorizeBtn').addEventListener('click', signIn);
        document.getElementById('signOutBtn').addEventListener('click', signOut);

        // ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°
        window.addEventListener('error', function(e) {
            console.error('ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚¨ãƒ©ãƒ¼:', e.error);
            showStatus('âŒ äºˆæœŸã—ãªã„ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚ãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿ã—ã¦ãã ã•ã„ã€‚', 'error');
        });

        // ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ˜ãƒƒãƒ€ãƒ¼ç¢ºèªï¼ˆé–‹ç™ºæ™‚ã®ã¿ï¼‰
        if (window.location.protocol !== 'https:' && window.location.hostname !== 'localhost') {
            console.warn('âš ï¸ HTTPSæ¥ç¶šã‚’æ¨å¥¨ã—ã¾ã™');
        }
    </script>
</body>
</html>
