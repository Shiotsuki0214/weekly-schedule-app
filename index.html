// Google APIÂàùÊúüÂåñ
        async function initializeGapi() {
            try {
                await new Promise((resolve) => {
                    gapi.load('auth2:client', resolve);
                });

                await gapi.client.init({
                    apiKey: API_KEY,
                    clientId: CLIENT_ID,
                    discoveryDocs: [DISCOVERY_DOC, 'https://sheets.googleapis.com/$discovery/rest?version=v4'],
                    scope: SCOPES
                });

                const authInstance = gapi.auth2.getAuthInstance();
                isSignedIn = authInstance.isSignedIn.get();
                
                updateAuthStatus();
                
                // „Çµ„Ç§„É≥„Ç§„É≥Áä∂ÊÖã„ÅÆÂ§âÂåñ„ÇíÁõ£Ë¶ñ
                authInstance.isSignedIn.listen(updateAuthStatus);
                
                console.log('Google APIÂàùÊúüÂåñÂÆå‰∫Ü');
            } catch (error) {
                console.error('Google APIÂàùÊúüÂåñ„Ç®„É©„Éº:', error);
                showAuthStatus('‚ùå Google APIÂàùÊúüÂåñ„Å´Â§±Êïó„Åó„Åæ„Åó„Åü', 'error');
            }
        }

        // Ë™çË®ºÁä∂ÊÖãÊõ¥Êñ∞
        function updateAuthStatus() {
            const authInstance = gapi.auth2.getAuthInstance();
            isSignedIn = authInstance.isSignedIn.get();
            
            const authorizeBtn = document.getElementById('authorizeBtn');
            
            if (isSignedIn) {
                const user = authInstance.currentUser.get();
                const profile = user.getBasicProfile();
                authorizeBtn.textContent = `‚úÖ ${profile.getName()}„Åß„Çµ„Ç§„É≥„Ç§„É≥‰∏≠`;
                authorizeBtn.disabled = true;
                showAuthStatus('‚úÖ GoogleË™çË®º„ÅåÂÆå‰∫Ü„Åó„Åæ„Åó„Åü„ÄÇ„Ç´„É¨„É≥„ÉÄ„Éº„Å®„Çπ„Éó„É¨„ÉÉ„Éâ„Ç∑„Éº„Éà„Å´„Ç¢„ÇØ„Çª„Çπ„Åß„Åç„Åæ„Åô„ÄÇ', 'success');
            } else {
                authorizeBtn.textContent = 'üîì Google„Ç¢„Ç´„Ç¶„É≥„Éà„Åß„Çµ„Ç§„É≥„Ç§„É≥';
                authorizeBtn.disabled = false;
                showAuthStatus('‚ö†Ô∏è GoogleË™çË®º„ÅåÂøÖË¶Å„Åß„Åô', 'info');
            }
            
            checkFormCompletion();
        }

        // Ë™çË®º„Çπ„ÉÜ„Éº„Çø„ÇπË°®Á§∫
        function showAuthStatus(message, type) {
            const authStatus = document.getElementById('authStatus');
            authStatus.innerHTML = `<div class="status-message status-${type}">${message}</div>`;
        }

        // „Çµ„Ç§„É≥„Ç§„É≥Âá¶ÁêÜ
        async function signIn() {
            try {
                const authInstance = gapi.auth2.getAuthInstance();
                await authInstance.signIn();
            } catch (error) {
                console.error('„Çµ„Ç§„É≥„Ç§„É≥„Ç®„É©„Éº:', error);
                showAuthStatus('‚ùå „Çµ„Ç§„É≥„Ç§„É≥„Å´Â§±Êïó„Åó„Åæ„Åó„Åü', 'error');
            }
        }<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ÈÄ±Ê°àÁÆ°ÁêÜ„Ç¢„Éó„É™</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Hiragino Sans', 'Yu Gothic', 'Meiryo', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            font-weight: 300;
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .main-content {
            padding: 40px;
        }

        .section {
            margin-bottom: 40px;
            background: #f8f9fa;
            border-radius: 15px;
            padding: 30px;
            border-left: 5px solid #4facfe;
        }

        .section h2 {
            color: #333;
            margin-bottom: 20px;
            font-size: 1.5rem;
            display: flex;
            align-items: center;
        }

        .section h2::before {
            content: '';
            width: 8px;
            height: 8px;
            background: #4facfe;
            border-radius: 50%;
            margin-right: 15px;
        }

        .form-group {
            margin-bottom: 25px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }

        .form-control {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 1rem;
            transition: all 0.3s ease;
            background: white;
        }

        .form-control:focus {
            outline: none;
            border-color: #4facfe;
            box-shadow: 0 0 0 3px rgba(79, 172, 254, 0.1);
        }

        .file-input-wrapper {
            position: relative;
            display: inline-block;
            cursor: pointer;
            width: 100%;
        }

        .file-input {
            opacity: 0;
            position: absolute;
            z-index: -1;
        }

        .file-input-label {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
            border: 2px dashed #4facfe;
            border-radius: 10px;
            background: rgba(79, 172, 254, 0.05);
            color: #4facfe;
            font-weight: 600;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .file-input-label:hover {
            background: rgba(79, 172, 254, 0.1);
            border-color: #0084ff;
        }

        .file-input-label.has-file {
            background: rgba(40, 167, 69, 0.1);
            border-color: #28a745;
            color: #28a745;
        }

        .btn {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 10px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            box-shadow: 0 4px 15px rgba(79, 172, 254, 0.3);
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(79, 172, 254, 0.4);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .preview-area {
            margin-top: 20px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            padding: 20px;
            background: white;
            min-height: 200px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .preview-image {
            max-width: 100%;
            max-height: 400px;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .status-message {
            padding: 15px 20px;
            border-radius: 10px;
            margin-top: 20px;
            font-weight: 600;
        }

        .status-success {
            background: rgba(40, 167, 69, 0.1);
            color: #28a745;
            border: 1px solid rgba(40, 167, 69, 0.2);
        }

        .status-error {
            background: rgba(220, 53, 69, 0.1);
            color: #dc3545;
            border: 1px solid rgba(220, 53, 69, 0.2);
        }

        .status-info {
            background: rgba(23, 162, 184, 0.1);
            color: #17a2b8;
            border: 1px solid rgba(23, 162, 184, 0.2);
        }

        .schedule-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .day-column {
            background: white;
            border-radius: 10px;
            padding: 20px;
            border: 2px solid #e0e0e0;
        }

        .day-header {
            font-weight: bold;
            text-align: center;
            padding: 10px;
            background: #4facfe;
            color: white;
            border-radius: 8px;
            margin-bottom: 15px;
        }

        .period-item {
            padding: 8px 12px;
            margin: 5px 0;
            background: #f8f9fa;
            border-radius: 6px;
            border-left: 3px solid #4facfe;
            font-size: 0.9rem;
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #4facfe;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .hidden {
            display: none;
        }

        .grid-2 {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        @media (max-width: 768px) {
            .grid-2 {
                grid-template-columns: 1fr;
            }
            
            .header h1 {
                font-size: 2rem;
            }
            
            .main-content {
                padding: 20px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üìÖ ÈÄ±Ê°àÁÆ°ÁêÜ„Ç¢„Éó„É™</h1>
            <p>ÈÄ±Ê°àÁîªÂÉè„Åã„ÇâGoogle„Ç´„É¨„É≥„ÉÄ„Éº„Å®„Çπ„Éó„É¨„ÉÉ„Éâ„Ç∑„Éº„Éà„ÇíËá™ÂãïÊõ¥Êñ∞</p>
        </div>

        <div class="main-content">
            <!-- GoogleË™çË®º„Çª„ÇØ„Ç∑„Éß„É≥ -->
            <div class="section">
                <h2>üîê GoogleË™çË®º</h2>
                <div id="authSection">
                    <button id="authorizeBtn" class="btn">
                        üîì Google„Ç¢„Ç´„Ç¶„É≥„Éà„Åß„Çµ„Ç§„É≥„Ç§„É≥
                    </button>
                    <div id="authStatus" style="margin-top: 15px;"></div>
                </div>
            </div>

            <!-- ÁîªÂÉè„Ç¢„ÉÉ„Éó„É≠„Éº„Éâ„Çª„ÇØ„Ç∑„Éß„É≥ -->
            <div class="section">
                <h2>üì∑ ÈÄ±Ê°àÁîªÂÉè„ÅÆ„Ç¢„ÉÉ„Éó„É≠„Éº„Éâ</h2>
                <div class="form-group">
                    <div class="file-input-wrapper">
                        <input type="file" id="imageFile" class="file-input" accept="image/*">
                        <label for="imageFile" class="file-input-label" id="fileLabel">
                            üìÅ ÈÄ±Ê°àÁîªÂÉè„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ
                        </label>
                    </div>
                </div>
                <div class="preview-area" id="previewArea">
                    <p style="color: #666;">ÁîªÂÉè„Çí„Ç¢„ÉÉ„Éó„É≠„Éº„Éâ„Åô„Çã„Å®„Åì„Åì„Å´„Éó„É¨„Éì„É•„Éº„ÅåË°®Á§∫„Åï„Çå„Åæ„Åô</p>
                </div>
            </div>

            <!-- Âá¶ÁêÜÂÆüË°å„Çª„ÇØ„Ç∑„Éß„É≥ -->
            <div class="section">
                <h2>‚öôÔ∏è Âá¶ÁêÜÂÆüË°å</h2>
                <button id="processBtn" class="btn" disabled>
                    üìÖ „Ç´„É¨„É≥„ÉÄ„Éº„Å®„Çπ„Éó„É¨„ÉÉ„Éâ„Ç∑„Éº„Éà„ÇíÊõ¥Êñ∞
                </button>
                <div id="statusArea"></div>
            </div>

            <!-- Ëß£ÊûêÁµêÊûúË°®Á§∫„Çª„ÇØ„Ç∑„Éß„É≥ -->
            <div class="section hidden" id="resultsSection">
                <h2>üìä Ëß£ÊûêÁµêÊûú</h2>
                <div id="schedulePreview" class="schedule-grid"></div>
            </div>
        </div>
    </div>

    <script src="https://apis.google.com/js/api.js"></script>
    <script src="https://accounts.google.com/gsi/client"></script>
    <script>
        // Google APIË®≠ÂÆö
        const CLIENT_ID = '128812767208-k0aqkvnccauv1r7ukajqsungulquit4u.apps.googleusercontent.com'; // „Åì„Åì„Å´ÂÆüÈöõ„ÅÆClient ID„ÇíË®≠ÂÆö„Åó„Å¶„Åè„Å†„Åï„ÅÑ
        const API_KEY = 'AIzaSyAi6BG9NeJFHh6s565E7obnbE27wpmqP-k'; // „Åì„Åì„Å´ÂÆüÈöõ„ÅÆAPI Key„ÇíË®≠ÂÆö„Åó„Å¶„Åè„Å†„Åï„ÅÑ
        const DISCOVERY_DOC = 'https://www.googleapis.com/discovery/v1/apis/calendar/v3/rest';
        const SCOPES = 'https://www.googleapis.com/auth/calendar https://www.googleapis.com/auth/spreadsheets';
        const SPREADSHEET_ID = '1RUYuKXKIKqMZ7M6B9cJnRHEsoAGqx1tkqXgBvK8jzLk';

        let gapi;
        let google;
        let isSignedIn = false;

        // „Ç∞„É≠„Éº„Éê„É´Â§âÊï∞
        let scheduleData = null;
        let timeSlots = null;

        // ÈÄ±ÊôÇÁ®ãË°®CSV„Éá„Éº„ÇøÔºàÂüã„ÇÅËæº„ÅøÔºâ
        const csvData = `Subject,ÊõúÊó•,ÈñãÂßãÊôÇÂàª,ÁµÇ‰∫ÜÊôÇÂàª
Ë™≠Êõ∏„Çø„Ç§„É†,Êúà,8:10,8:25
1ÊôÇÈñìÁõÆ,Êúà,8:40,9:25
2ÊôÇÈñìÁõÆ,Êúà,9:30,10:15
‰∏≠‰ºë„Åø,Êúà,10:15,10:35
3ÊôÇÈñìÁõÆ,Êúà,10:35,11:20
4ÊôÇÈñìÁõÆ,Êúà,11:25,12:10
Áµ¶È£ü,Êúà,12:10,12:50
Êòº‰ºë„Åø,Êúà,12:50,13:20
5ÊôÇÈñìÁõÆ,Êúà,13:25,14:10
6ÊôÇÈñìÁõÆ,Êúà,14:15,15:00
Â∏∞„Çä„ÅÆ‰ºö,Êúà,15:00,15:15
ËÅ∑Âì°‰ºöË≠∞„Éª„Ç±„Éº„Çπ‰ºöË≠∞,Êúà,15:30,16:40
Â≠¶„Å≥Â≠êÔºàÁÆóÊï∞Ôºâ,ÁÅ´,8:10,8:25
1ÊôÇÈñìÁõÆ,ÁÅ´,8:40,9:25
2ÊôÇÈñìÁõÆ,ÁÅ´,9:30,10:15
‰∏≠‰ºë„Åø,ÁÅ´,10:15,10:35
3ÊôÇÈñìÁõÆ,ÁÅ´,10:35,11:20
4ÊôÇÈñìÁõÆ,ÁÅ´,11:25,12:10
Áµ¶È£ü,ÁÅ´,12:10,12:50
Êòº‰ºë„Åø,ÁÅ´,12:50,13:20
Ê∏ÖÊéÉ,ÁÅ´,13:25,13:45
5ÊôÇÈñìÁõÆ,ÁÅ´,13:45,14:30
6ÊôÇÈñìÁõÆ,ÁÅ´,14:35,15:20
Â∏∞„Çä„ÅÆ‰ºö,ÁÅ´,15:20,15:35
Â≠¶Âπ¥‰ºö,ÁÅ´,16:00,16:40
„Éï„ÉÉÂåñÁâ©Ê¥óÂè£,Ê∞¥,8:10,8:25
1ÊôÇÈñìÁõÆ,Ê∞¥,8:40,9:25
2ÊôÇÈñìÁõÆ,Ê∞¥,9:30,10:15
‰∏≠‰ºë„Åø,Ê∞¥,10:15,10:35
3ÊôÇÈñìÁõÆ,Ê∞¥,10:35,11:20
4ÊôÇÈñìÁõÆ,Ê∞¥,11:25,12:10
Áµ¶È£ü,Ê∞¥,12:10,12:50
Êòº‰ºë„Åø,Ê∞¥,12:50,13:20
Ê∏ÖÊéÉ,Ê∞¥,13:25,13:45
5ÊôÇÈñìÁõÆ,Ê∞¥,13:45,14:30
Â∏∞„Çä„ÅÆ‰ºö,Ê∞¥,14:30,14:45
Ê†°ÂÜÖÁ†î‰øÆ,Ê∞¥,15:15,16:40
ÂÖ®Ê†°„Çø„Ç§„É†,Êú®,8:10,8:25
1ÊôÇÈñìÁõÆ,Êú®,8:40,9:25
2ÊôÇÈñìÁõÆ,Êú®,9:30,10:15
‰∏≠‰ºë„Åø,Êú®,10:15,10:35
3ÊôÇÈñìÁõÆ,Êú®,10:35,11:20
4ÊôÇÈñìÁõÆ,Êú®,11:25,12:10
Áµ¶È£ü,Êú®,12:10,12:50
Êòº‰ºë„Åø,Êú®,12:50,13:20
Ê∏ÖÊéÉ,Êú®,13:25,13:45
5ÊôÇÈñìÁõÆ,Êú®,13:45,14:30
6ÊôÇÈñìÁõÆ,Êú®,14:35,15:20
Â∏∞„Çä„ÅÆ‰ºö,Êú®,15:20,15:35
„ÉÅ„É£„É¨„É≥„Ç∏,Êú®,15:50,16:40
1Âπ¥Áîü,Èáë,8:10,8:25
1ÊôÇÈñìÁõÆ,Èáë,8:40,9:25
2ÊôÇÈñìÁõÆ,Èáë,9:30,10:15
‰∏≠‰ºë„Åø,Èáë,10:15,10:35
3ÊôÇÈñìÁõÆ,Èáë,10:35,11:20
4ÊôÇÈñìÁõÆ,Èáë,11:25,12:10
Áµ¶È£ü,Èáë,12:10,12:50
Êòº‰ºë„Åø,Èáë,12:50,13:20
Ê∏ÖÊéÉ,Èáë,13:25,13:45
5ÊôÇÈñìÁõÆ,Èáë,13:45,14:30
6ÊôÇÈñìÁõÆ,Èáë,14:35,15:20
Â∏∞„Çä„ÅÆ‰ºö,Èáë,15:20,15:35
Â§ñÈÉ®Ë¨õÂ∏´,Èáë,15:35,17:05`;

        // ÈÄ±ÊôÇÁ®ãË°®„Éá„Éº„Çø„ÅÆËß£Êûê
        function loadTimeSlots() {
            try {
                // PapaParse‰ΩøÁî®„Åõ„Åö„Å´ÊâãÂãïËß£Êûê
                const lines = csvData.trim().split('\n');
                const headers = lines[0].split(',');
                
                timeSlots = lines.slice(1).map(line => {
                    const values = line.split(',');
                    const obj = {};
                    headers.forEach((header, index) => {
                        obj[header] = values[index];
                    });
                    return obj;
                });
                
                console.log('ÊôÇÁ®ãË°®„Éá„Éº„Çø„ÇíË™≠„ÅøËæº„Åø„Åæ„Åó„Åü:', timeSlots);
                showStatus('üìö ÊôÇÁ®ãË°®„Éá„Éº„Çø„ÇíË™≠„ÅøËæº„ÅøÂÆå‰∫Ü', 'success');
                return true;
            } catch (error) {
                console.error('ÊôÇÁ®ãË°®„Éá„Éº„Çø„ÅÆË™≠„ÅøËæº„Åø„Ç®„É©„Éº:', error);
                showStatus('ÊôÇÁ®ãË°®„Éá„Éº„Çø„ÅÆË™≠„ÅøËæº„Åø„Å´Â§±Êïó„Åó„Åæ„Åó„Åü', 'error');
                return false;
            }
        }

        // „Éö„Éº„Ç∏Ë™≠„ÅøËæº„ÅøÊôÇ„ÅÆÂàùÊúüÂåñ
        document.addEventListener('DOMContentLoaded', function() {
            // ÊôÇÁ®ãË°®„Éá„Éº„Çø„ÇíË™≠„ÅøËæº„Åø
            loadTimeSlots();
            
            // Google APIÂàùÊúüÂåñ
            initializeGapi();
            
            // ÂàùÊúüÁä∂ÊÖã„Åß„Éï„Ç©„Éº„É†ÂÆå‰∫Ü„ÉÅ„Çß„ÉÉ„ÇØ
            setTimeout(checkFormCompletion, 100);
        });

        // „Çµ„Ç§„É≥„Ç§„É≥„Éú„Çø„É≥„Ç§„Éô„É≥„Éà
        document.getElementById('authorizeBtn').addEventListener('click', signIn);

        // „Éï„Ç°„Ç§„É´„Ç¢„ÉÉ„Éó„É≠„Éº„ÉâÂá¶ÁêÜ
        document.getElementById('imageFile').addEventListener('change', function(e) {
            const file = e.target.files[0];
            const label = document.getElementById('fileLabel');
            const previewArea = document.getElementById('previewArea');
            const processBtn = document.getElementById('processBtn');

            console.log('„Éï„Ç°„Ç§„É´ÈÅ∏Êäû:', file); // „Éá„Éê„ÉÉ„Ç∞Áî®

            if (file) {
                // „Éï„Ç°„Ç§„É´„Çø„Ç§„Éó„ÅÆÊ§úË®º
                if (!file.type.startsWith('image/')) {
                    showStatus('‚ùå ÁîªÂÉè„Éï„Ç°„Ç§„É´„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ', 'error');
                    this.value = ''; // „Éï„Ç°„Ç§„É´ÈÅ∏Êäû„Çí„É™„Çª„ÉÉ„Éà
                    return;
                }

                label.textContent = `‚úÖ ${file.name} (${(file.size / 1024 / 1024).toFixed(1)}MB)`;
                label.classList.add('has-file');
                
                // ÁîªÂÉè„Éó„É¨„Éì„É•„Éº
                const reader = new FileReader();
                reader.onload = function(e) {
                    previewArea.innerHTML = `<img src="${e.target.result}" class="preview-image" alt="ÈÄ±Ê°à„Éó„É¨„Éì„É•„Éº">`;
                };
                reader.onerror = function() {
                    showStatus('‚ùå ÁîªÂÉè„ÅÆË™≠„ÅøËæº„Åø„Å´Â§±Êïó„Åó„Åæ„Åó„Åü', 'error');
                };
                reader.readAsDataURL(file);
                
                // „Éú„Çø„É≥„ÇíÊúâÂäπÂåñÔºà‰ªñ„ÅÆÊù°‰ª∂„ÇÇ„ÉÅ„Çß„ÉÉ„ÇØÔºâ
                checkFormCompletion();
                
                showStatus('‚úÖ ÁîªÂÉè„ÅåÊ≠£Â∏∏„Å´„Ç¢„ÉÉ„Éó„É≠„Éº„Éâ„Åï„Çå„Åæ„Åó„Åü', 'success');
            } else {
                label.textContent = 'üìÅ ÈÄ±Ê°àÁîªÂÉè„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ';
                label.classList.remove('has-file');
                previewArea.innerHTML = '<p style="color: #666;">ÁîªÂÉè„Çí„Ç¢„ÉÉ„Éó„É≠„Éº„Éâ„Åô„Çã„Å®„Åì„Åì„Å´„Éó„É¨„Éì„É•„Éº„ÅåË°®Á§∫„Åï„Çå„Åæ„Åô</p>';
                processBtn.disabled = true;
                showStatus('', ''); // „Çπ„ÉÜ„Éº„Çø„Çπ„Çí„ÇØ„É™„Ç¢
            }
        });

        // „Éï„Ç©„Éº„É†ÂÆå‰∫Ü„ÉÅ„Çß„ÉÉ„ÇØ
        function checkFormCompletion() {
            const imageFile = document.getElementById('imageFile').files[0];
            const processBtn = document.getElementById('processBtn');

            const isComplete = imageFile && timeSlots && timeSlots.length > 0 && isSignedIn;
            processBtn.disabled = !isComplete;

            console.log('„Éï„Ç©„Éº„É†ÂÆå‰∫Ü„ÉÅ„Çß„ÉÉ„ÇØ:', {
                imageFile: !!imageFile,
                timeSlots: !!(timeSlots && timeSlots.length > 0),
                isSignedIn: isSignedIn,
                isComplete: isComplete
            });
        }

        // ÂÖ•Âäõ„Éï„Ç£„Éº„É´„Éâ„ÅÆÂ§âÊõ¥Áõ£Ë¶ñ„ÅØÂâäÈô§ÔºàÁîªÂÉè„Éï„Ç°„Ç§„É´„ÅÆ„ÅøÁõ£Ë¶ñÔºâ

        // „Çπ„ÉÜ„Éº„Çø„Çπ„É°„ÉÉ„Çª„Éº„Ç∏Ë°®Á§∫
        function showStatus(message, type = 'info') {
            const statusArea = document.getElementById('statusArea');
            statusArea.innerHTML = `<div class="status-message status-${type}">${message}</div>`;
        }

        // ÁîªÂÉèËß£ÊûêÔºàÊ®°Êì¨ÂÆüË£ÖÔºâ
        async function analyzeScheduleImage(imageFile) {
            // ÂÆüÈöõ„ÅÆÂÆüË£Ö„Åß„ÅØ„ÄÅOCR„É©„Ç§„Éñ„É©„É™„ÇÑAI API„Çí‰ΩøÁî®
            // „Åì„Åì„Åß„ÅØÈÄ±Ê°à„ÅÆÊ®°Êì¨„Éá„Éº„Çø„ÇíËøî„Åô
            showStatus('üîç ÁîªÂÉè„ÇíËß£Êûê‰∏≠...', 'info');
            
            // Ê®°Êì¨ÁöÑ„Å™Ëß£ÊûêÁµêÊûúÔºàÂÆüÈöõ„ÅÆÈÄ±Ê°àÁîªÂÉè„Å´Âü∫„Å•„ÅèÔºâ
            const mockSchedule = {
                'Êúà': {
                    '1ÊôÇÈñìÁõÆ': 'ÂõΩË™û',
                    '2ÊôÇÈñìÁõÆ': 'ÁÆóÊï∞',
                    '3ÊôÇÈñìÁõÆ': 'Á∑èÂêà',
                    '4ÊôÇÈñìÁõÆ': 'ÁêÜÁßë',
                    '5ÊôÇÈñìÁõÆ': 'Âõ≥Â∑•',
                    '6ÊôÇÈñìÁõÆ': 'Âõ≥Â∑•'
                },
                'ÁÅ´': {
                    '1ÊôÇÈñìÁõÆ': 'ÁÆóÊï∞',
                    '2ÊôÇÈñìÁõÆ': 'ÂõΩË™û',
                    '3ÊôÇÈñìÁõÆ': 'Á§æ‰ºö',
                    '4ÊôÇÈñìÁõÆ': '‰ΩìËÇ≤',
                    '5ÊôÇÈñìÁõÆ': 'ÁêÜÁßë',
                    '6ÊôÇÈñìÁõÆ': 'ÂßîÂì°‰ºöÊ¥ªÂãï'
                },
                'Ê∞¥': {
                    '1ÊôÇÈñìÁõÆ': 'ÁâπÊ¥ª',
                    '2ÊôÇÈñìÁõÆ': 'ÂõΩË™û',
                    '3ÊôÇÈñìÁõÆ': 'ÁÆóÊï∞',
                    '4ÊôÇÈñìÁõÆ': 'Â§ñÂõΩË™û',
                    '5ÊôÇÈñìÁõÆ': 'Á§æ‰ºö'
                },
                'Êú®': {
                    '1ÊôÇÈñìÁõÆ': 'ÁÆóÊï∞',
                    '2ÊôÇÈñìÁõÆ': 'Êõ∏ÂÜô',
                    '3ÊôÇÈñìÁõÆ': 'Á§æ‰ºö',
                    '4ÊôÇÈñìÁõÆ': 'Â§ñÂõΩË™ûÔºàALTÔºâ',
                    '5ÊôÇÈñìÁõÆ': 'Èü≥Ê•Ω',
                    '6ÊôÇÈñìÁõÆ': 'Á∑èÂêà'
                },
                'Èáë': {
                    '1ÊôÇÈñìÁõÆ': 'ÂõΩË™û',
                    '2ÊôÇÈñìÁõÆ': 'ÁÆóÊï∞',
                    '3ÊôÇÈñìÁõÆ': 'ÂÆ∂Â∫≠',
                    '4ÊôÇÈñìÁõÆ': 'ÁêÜÁßë',
                    '5ÊôÇÈñìÁõÆ': 'Á∑èÂêà',
                    '6ÊôÇÈñìÁõÆ': 'Á∑èÂêà'
                }
            };

            await new Promise(resolve => setTimeout(resolve, 2000)); // Ëß£ÊûêÊôÇÈñì„ÅÆÊ®°Êì¨
            return mockSchedule;
        }

        // ÊôÇÈñì„Çí24ÊôÇÈñìÂΩ¢Âºè„Å´Â§âÊèõ
        function parseTime(timeStr) {
            const [hours, minutes] = timeStr.split(':').map(Number);
            return { hours, minutes };
        }

        // Êó•‰ªò„Å®ÊôÇÂàª„Åã„ÇâDate„Ç™„Éñ„Ç∏„Çß„ÇØ„Éà„Çí‰ΩúÊàê
        function createDateTime(baseDate, timeStr) {
            const { hours, minutes } = parseTime(timeStr);
            const date = new Date(baseDate);
            date.setHours(hours, minutes, 0, 0);
            return date;
        }

        // Google„Ç´„É¨„É≥„ÉÄ„Éº„Ç§„Éô„É≥„Éà‰ΩúÊàêÔºàÂÆüË£ÖÔºâ
        async function createCalendarEvent(title, startDate, endDate, description = '') {
            try {
                const event = {
                    summary: title,
                    start: {
                        dateTime: startDate.toISOString(),
                        timeZone: 'Asia/Tokyo'
                    },
                    end: {
                        dateTime: endDate.toISOString(),
                        timeZone: 'Asia/Tokyo'
                    },
                    description: description
                };

                const response = await gapi.client.calendar.events.insert({
                    calendarId: 'primary',
                    resource: event
                });

                console.log('„Ç§„Éô„É≥„Éà‰ΩúÊàêÊàêÂäü:', response);
                return response.result;
            } catch (error) {
                console.error('„Ç§„Éô„É≥„Éà‰ΩúÊàê„Ç®„É©„Éº:', error);
                throw error;
            }
        }

        // „Çπ„Éó„É¨„ÉÉ„Éâ„Ç∑„Éº„ÉàÊõ¥Êñ∞ÔºàÂÆüË£ÖÔºâ
        async function updateSpreadsheet(scheduleData, startDate) {
            try {
                showStatus('üìä „Çπ„Éó„É¨„ÉÉ„Éâ„Ç∑„Éº„Éà„ÇíÊõ¥Êñ∞‰∏≠...', 'info');
                
                // ÊïôÁßëÂà•ÊôÇÈñìÊï∞„ÇíÈõÜË®à
                const subjectCounts = {};
                const days = ['Êúà', 'ÁÅ´', 'Ê∞¥', 'Êú®', 'Èáë'];
                
                days.forEach(day => {
                    if (scheduleData[day]) {
                        Object.values(scheduleData[day]).forEach(subject => {
                            if (subject && subject !== 'Ôºç') {
                                subjectCounts[subject] = (subjectCounts[subject] || 0) + 1;
                            }
                        });
                    }
                });

                console.log('ÊïôÁßëÂà•ÊôÇÈñìÊï∞:', subjectCounts);

                // „Éá„Éº„Çø„Ç∑„Éº„Éà„Å´ÊôÇÈñìÊï∞„ÇíË®òÈå≤
                const dataValues = [];
                Object.entries(subjectCounts).forEach(([subject, count]) => {
                    dataValues.push([new Date().toISOString().split('T')[0], subject, count]);
                });

                if (dataValues.length > 0) {
                    await gapi.client.sheets.spreadsheets.values.append({
                        spreadsheetId: SPREADSHEET_ID,
                        range: '„Éá„Éº„Çø!A:C',
                        valueInputOption: 'RAW',
                        resource: {
                            values: dataValues
                        }
                    });
                }

                // ÈÄ±Ê°à„Ç∑„Éº„Éà„Å´ÈÄ±Ê°à„Éá„Éº„Çø„ÇíË®òÈå≤
                const monday = new Date(startDate);
                const weekValues = [];
                
                // „Éò„ÉÉ„ÉÄ„ÉºË°åÔºàÊó•‰ªòÔºâ
                const dateRow = ['ÊôÇÈñì'];
                for (let i = 0; i < 5; i++) {
                    const date = new Date(monday);
                    date.setDate(monday.getDate() + i);
                    dateRow.push(`${date.getMonth() + 1}/${date.getDate()}(${days[i]})`);
                }
                weekValues.push(dateRow);

                // ÂêÑÊôÇÈñìÁõÆ„ÅÆ„Éá„Éº„Çø
                const periods = ['1ÊôÇÈñìÁõÆ', '2ÊôÇÈñìÁõÆ', '3ÊôÇÈñìÁõÆ', '4ÊôÇÈñìÁõÆ', '5ÊôÇÈñìÁõÆ', '6ÊôÇÈñìÁõÆ'];
                periods.forEach(period => {
                    const row = [period];
                    days.forEach(day => {
                        const subject = scheduleData[day] && scheduleData[day][period] ? scheduleData[day][period] : '';
                        row.push(subject);
                    });
                    weekValues.push(row);
                });

                // ÈÄ±Ê°à„Ç∑„Éº„Éà„ÇíÊõ¥Êñ∞
                await gapi.client.sheets.spreadsheets.values.update({
                    spreadsheetId: SPREADSHEET_ID,
                    range: 'ÈÄ±Ê°à!A1:F7',
                    valueInputOption: 'RAW',
                    resource: {
                        values: weekValues
                    }
                });

                console.log('„Çπ„Éó„É¨„ÉÉ„Éâ„Ç∑„Éº„ÉàÊõ¥Êñ∞ÂÆå‰∫Ü');
                return subjectCounts;
            } catch (error) {
                console.error('„Çπ„Éó„É¨„ÉÉ„Éâ„Ç∑„Éº„ÉàÊõ¥Êñ∞„Ç®„É©„Éº:', error);
                throw error;
            }
        }

        // Âá¶ÁêÜÂÆüË°å
        document.getElementById('processBtn').addEventListener('click', async function() {
            const imageFileInput = document.getElementById('imageFile');
            const imageFile = imageFileInput.files[0];

            // Ë™çË®º„ÉÅ„Çß„ÉÉ„ÇØ
            if (!isSignedIn) {
                showStatus('‚ùå Google„Ç¢„Ç´„Ç¶„É≥„Éà„Åß„Çµ„Ç§„É≥„Ç§„É≥„Åó„Å¶„Åè„Å†„Åï„ÅÑ', 'error');
                return;
            }

            if (!imageFile) {
                showStatus('‚ùå ÈÄ±Ê°àÁîªÂÉè„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ', 'error');
                return;
            }

            if (!timeSlots || timeSlots.length === 0) {
                showStatus('‚ùå ÊôÇÁ®ãË°®„Éá„Éº„Çø„ÅåË™≠„ÅøËæº„Åæ„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì', 'error');
                return;
            }

            try {
                this.innerHTML = '<span class="loading"></span>Âá¶ÁêÜ‰∏≠...';
                this.disabled = true;

                // 1. ÁîªÂÉèËß£Êûê
                scheduleData = await analyzeScheduleImage(imageFile);
                
                // 2. Ëß£ÊûêÁµêÊûúË°®Á§∫
                displaySchedulePreview(scheduleData);
                
                // 3. „Ç´„É¨„É≥„ÉÄ„Éº„Ç§„Éô„É≥„Éà‰ΩúÊàêÔºàÁèæÂú®„ÅÆÊó•‰ªò„Åã„ÇâÊúàÊõúÊó•„ÇíËá™ÂãïË®àÁÆóÔºâ
                const today = new Date();
                const monday = new Date(today);
                const day = today.getDay();
                const diff = today.getDate() - day + (day === 0 ? -6 : 1);
                monday.setDate(diff);
                const startDateStr = monday.toISOString().split('T')[0];
                
                showStatus('üìÖ Google„Ç´„É¨„É≥„ÉÄ„Éº„Å´‰∫àÂÆö„ÇíËøΩÂä†‰∏≠...', 'info');
                const events = await createCalendarEvents(scheduleData, startDateStr);
                
                // 4. „Çπ„Éó„É¨„ÉÉ„Éâ„Ç∑„Éº„ÉàÊõ¥Êñ∞
                const subjectCounts = await updateSpreadsheet(scheduleData, startDateStr);
                
                showStatus(`‚úÖ Âá¶ÁêÜ„ÅåÂÆå‰∫Ü„Åó„Åæ„Åó„ÅüÔºÅ ${events.length}‰ª∂„ÅÆ„Ç§„Éô„É≥„Éà„Çí‰ΩúÊàê„Åó„ÄÅ„Çπ„Éó„É¨„ÉÉ„Éâ„Ç∑„Éº„Éà„ÇíÊõ¥Êñ∞„Åó„Åæ„Åó„Åü„ÄÇ`, 'success');
                
            } catch (error) {
                console.error('Âá¶ÁêÜ„Ç®„É©„Éº:', error);
                showStatus(`‚ùå Âá¶ÁêÜ‰∏≠„Å´„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü: ${error.message}`, 'error');
            } finally {
                this.innerHTML = 'üìÖ „Ç´„É¨„É≥„ÉÄ„Éº„Å®„Çπ„Éó„É¨„ÉÉ„Éâ„Ç∑„Éº„Éà„ÇíÊõ¥Êñ∞';
                this.disabled = false;
            }
        });

        // „Ç´„É¨„É≥„ÉÄ„Éº„Ç§„Éô„É≥„Éà‰ΩúÊàê
        async function createCalendarEvents(scheduleData, startDateStr) {
            const events = [];
            const startDate = new Date(startDateStr);
            const days = ['Êúà', 'ÁÅ´', 'Ê∞¥', 'Êú®', 'Èáë'];
            
            for (let dayIndex = 0; dayIndex < days.length; dayIndex++) {
                const day = days[dayIndex];
                const currentDate = new Date(startDate);
                currentDate.setDate(startDate.getDate() + dayIndex);
                
                if (scheduleData[day]) {
                    // „Åù„ÅÆÊó•„ÅÆÊôÇÁ®ã„ÇíÂèñÂæó
                    const dayTimeSlots = timeSlots.filter(slot => slot.ÊõúÊó• === day);
                    
                    for (const [period, subject] of Object.entries(scheduleData[day])) {
                        if (subject && subject !== 'Ôºç') {
                            // ÂØæÂøú„Åô„ÇãÊôÇÁ®ã„ÇíÊ§úÁ¥¢
                            const timeSlot = dayTimeSlots.find(slot => slot.Subject === period);
                            
                            if (timeSlot) {
                                const startTime = createDateTime(currentDate, timeSlot.ÈñãÂßãÊôÇÂàª);
                                const endTime = createDateTime(currentDate, timeSlot.ÁµÇ‰∫ÜÊôÇÂàª);
                                
                                try {
                                    const event = await createCalendarEvent(
                                        subject,
                                        startTime,
                                        endTime,
                                        `${day}ÊõúÊó• ${period}`
                                    );
                                    events.push(event);
                                } catch (error) {
                                    console.error(`„Ç§„Éô„É≥„Éà‰ΩúÊàêÂ§±Êïó: ${subject}`, error);
                                }
                            }
                        }
                    }
                }
            }
            
            console.log(`${events.length}‰ª∂„ÅÆ„Ç§„Éô„É≥„Éà„Çí‰ΩúÊàê„Åó„Åæ„Åó„Åü`);
            return events;
        }

        // Ëß£ÊûêÁµêÊûúË°®Á§∫
        function displaySchedulePreview(scheduleData) {
            const resultsSection = document.getElementById('resultsSection');
            const schedulePreview = document.getElementById('schedulePreview');
            
            const days = ['Êúà', 'ÁÅ´', 'Ê∞¥', 'Êú®', 'Èáë'];
            const dayNames = ['ÊúàÊõúÊó•', 'ÁÅ´ÊõúÊó•', 'Ê∞¥ÊõúÊó•', 'Êú®ÊõúÊó•', 'ÈáëÊõúÊó•'];
            
            schedulePreview.innerHTML = '';
            
            days.forEach((day, index) => {
                const dayColumn = document.createElement('div');
                dayColumn.className = 'day-column';
                
                const dayHeader = document.createElement('div');
                dayHeader.className = 'day-header';
                dayHeader.textContent = dayNames[index];
                dayColumn.appendChild(dayHeader);
                
                if (scheduleData[day]) {
                    Object.entries(scheduleData[day]).forEach(([period, subject]) => {
                        const periodItem = document.createElement('div');
                        periodItem.className = 'period-item';
                        periodItem.innerHTML = `<strong>${period}:</strong> ${subject || 'Ôºç'}`;
                        dayColumn.appendChild(periodItem);
                    });
                } else {
                    const noData = document.createElement('div');
                    noData.className = 'period-item';
                    noData.style.color = '#999';
                    noData.textContent = '„Éá„Éº„Çø„Å™„Åó';
                    dayColumn.appendChild(noData);
                }
                
                schedulePreview.appendChild(dayColumn);
            });
            
            resultsSection.classList.remove('hidden');
        }
    </script>
</body>
</html>
