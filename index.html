// 認証ステータス表示
        function showAuthStatus(message, type) {
            const authStatus = document.getElementById('authStatus');
            authStatus.innerHTML = `<div class="status-message status-${type}">${message}</div>`;
        }<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>週案管理アプリ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Hiragino Sans', 'Yu Gothic', 'Meiryo', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            font-weight: 300;
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .main-content {
            padding: 40px;
        }

        .section {
            margin-bottom: 40px;
            background: #f8f9fa;
            border-radius: 15px;
            padding: 30px;
            border-left: 5px solid #4facfe;
        }

        .section h2 {
            color: #333;
            margin-bottom: 20px;
            font-size: 1.5rem;
            display: flex;
            align-items: center;
        }

        .section h2::before {
            content: '';
            width: 8px;
            height: 8px;
            background: #4facfe;
            border-radius: 50%;
            margin-right: 15px;
        }

        .form-group {
            margin-bottom: 25px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }

        .form-control {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 1rem;
            transition: all 0.3s ease;
            background: white;
        }

        .form-control:focus {
            outline: none;
            border-color: #4facfe;
            box-shadow: 0 0 0 3px rgba(79, 172, 254, 0.1);
        }

        .file-input-wrapper {
            position: relative;
            display: inline-block;
            cursor: pointer;
            width: 100%;
        }

        .file-input {
            opacity: 0;
            position: absolute;
            z-index: -1;
        }

        .file-input-label {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
            border: 2px dashed #4facfe;
            border-radius: 10px;
            background: rgba(79, 172, 254, 0.05);
            color: #4facfe;
            font-weight: 600;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .file-input-label:hover {
            background: rgba(79, 172, 254, 0.1);
            border-color: #0084ff;
        }

        .file-input-label.has-file {
            background: rgba(40, 167, 69, 0.1);
            border-color: #28a745;
            color: #28a745;
        }

        .btn {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 10px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            box-shadow: 0 4px 15px rgba(79, 172, 254, 0.3);
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(79, 172, 254, 0.4);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .preview-area {
            margin-top: 20px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            padding: 20px;
            background: white;
            min-height: 200px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .preview-image {
            max-width: 100%;
            max-height: 400px;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .status-message {
            padding: 15px 20px;
            border-radius: 10px;
            margin-top: 20px;
            font-weight: 600;
        }

        .status-success {
            background: rgba(40, 167, 69, 0.1);
            color: #28a745;
            border: 1px solid rgba(40, 167, 69, 0.2);
        }

        .status-error {
            background: rgba(220, 53, 69, 0.1);
            color: #dc3545;
            border: 1px solid rgba(220, 53, 69, 0.2);
        }

        .status-info {
            background: rgba(23, 162, 184, 0.1);
            color: #17a2b8;
            border: 1px solid rgba(23, 162, 184, 0.2);
        }

        .status-warning {
            background: rgba(255, 193, 7, 0.1);
            color: #856404;
            border: 1px solid rgba(255, 193, 7, 0.2);
        }

        .schedule-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .day-column {
            background: white;
            border-radius: 10px;
            padding: 20px;
            border: 2px solid #e0e0e0;
        }

        .day-header {
            font-weight: bold;
            text-align: center;
            padding: 10px;
            background: #4facfe;
            color: white;
            border-radius: 8px;
            margin-bottom: 15px;
        }

        .period-item {
            padding: 8px 12px;
            margin: 5px 0;
            background: #f8f9fa;
            border-radius: 6px;
            border-left: 3px solid #4facfe;
            font-size: 0.9rem;
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #4facfe;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .hidden {
            display: none;
        }

        .grid-2 {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .config-section {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 30px;
        }

        .config-section h3 {
            color: #856404;
            margin-bottom: 15px;
        }

        .usage-stats {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            border-radius: 10px;
            padding: 15px;
            margin-top: 20px;
        }

        @media (max-width: 768px) {
            .grid-2 {
                grid-template-columns: 1fr;
            }
            
            .header h1 {
                font-size: 2rem;
            }
            
            .main-content {
                padding: 20px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>📅 週案管理アプリ</h1>
            <p>週案画像からGoogleカレンダーとスプレッドシートを自動更新</p>
        </div>

        <div class="main-content">
            <!-- 設定セクション -->
            <div class="config-section">
                <h3>⚙️ 初期設定が必要です</h3>
                <p>このアプリを使用するには、Google Cloud ConsoleでAPIキーとクライアントIDを設定する必要があります。</p>
                <p><strong>config.js</strong> ファイルを作成し、以下の値を設定してください：</p>
                <pre style="background: #f8f9fa; padding: 10px; border-radius: 5px; margin: 10px 0;">
// config.js
window.APP_CONFIG = {
    CLIENT_ID: 'あなたのクライアントID',
    API_KEY: 'あなたのAPIキー',
    SPREADSHEET_ID: '1RUYuKXKIKqMZ7M6B9cJnRHEsoAGqx1tkqXgBvK8jzLk'
};
                </pre>
                <div id="configStatus" class="status-message status-warning">
                    ⚠️ 設定ファイルが読み込まれていません
                </div>
            </div>

            <!-- Google認証セクション -->
            <div class="section">
                <h2>🔐 Google認証</h2>
                <div id="authSection">
                    <button id="authorizeBtn" class="btn" disabled>
                        🔓 Googleアカウントでサインイン
                    </button>
                    <button id="signOutBtn" class="btn hidden" style="margin-left: 10px; background: #dc3545;">
                        🚪 サインアウト
                    </button>
                    <div id="authStatus" style="margin-top: 15px;"></div>
                </div>
                
                <!-- 使用量統計 -->
                <div id="usageStats" class="usage-stats hidden">
                    <h4>📊 今日の使用状況</h4>
                    <div id="statsContent"></div>
                </div>
            </div>

            <!-- 画像アップロードセクション -->
            <div class="section">
                <h2>📷 週案画像のアップロード</h2>
                <div class="form-group">
                    <div class="file-input-wrapper">
                        <input type="file" id="imageFile" class="file-input" accept="image/*">
                        <label for="imageFile" class="file-input-label" id="fileLabel">
                            📁 週案画像を選択してください
                        </label>
                    </div>
                </div>
                <div class="preview-area" id="previewArea">
                    <p style="color: #666;">画像をアップロードするとここにプレビューが表示されます</p>
                </div>
            </div>

            <!-- 処理実行セクション -->
            <div class="section">
                <h2>⚙️ 処理実行</h2>
                <button id="processBtn" class="btn" disabled>
                    📅 カレンダーとスプレッドシートを更新
                </button>
                <div id="statusArea"></div>
            </div>

            <!-- 解析結果表示セクション -->
            <div class="section hidden" id="resultsSection">
                <h2>📊 解析結果</h2>
                <div id="schedulePreview" class="schedule-grid"></div>
            </div>
        </div>
    </div>

    <script src="https://apis.google.com/js/api.js"></script>
    <script src="https://accounts.google.com/gsi/client"></script>
    <script src="config.js"></script>
    <script>
        // セキュリティ設定
        const SECURITY = {
            maxDailyRequests: 50,
            maxFileSize: 10 * 1024 * 1024, // 10MB
            allowedImageTypes: ['image/jpeg', 'image/png', 'image/jpg'],
            rateLimitWindow: 60000, // 1分
            maxRequestsPerWindow: 5
        };

        // 使用量追跡
        const usageTracker = {
            key: 'weeklyScheduleApp_usage',
            
            getTodayUsage() {
                const today = new Date().toDateString();
                const data = JSON.parse(localStorage.getItem(this.key) || '{}');
                return data[today] || { requests: 0, lastReset: Date.now() };
            },
            
            incrementUsage() {
                const today = new Date().toDateString();
                const data = JSON.parse(localStorage.getItem(this.key) || '{}');
                data[today] = { 
                    requests: (data[today]?.requests || 0) + 1, 
                    lastReset: Date.now() 
                };
                localStorage.setItem(this.key, JSON.stringify(data));
                this.updateStatsDisplay();
            },
            
            checkLimit() {
                const usage = this.getTodayUsage();
                return usage.requests < SECURITY.maxDailyRequests;
            },
            
            updateStatsDisplay() {
                const usage = this.getTodayUsage();
                const statsDiv = document.getElementById('statsContent');
                const remaining = SECURITY.maxDailyRequests - usage.requests;
                
                statsDiv.innerHTML = `
                    <p>今日の処理回数: ${usage.requests}/${SECURITY.maxDailyRequests}</p>
                    <p>残り処理可能回数: ${remaining}</p>
                    <p style="font-size: 0.9em; color: #666;">制限は日本時間の0時にリセットされます</p>
                `;
                
                if (remaining <= 5) {
                    statsDiv.innerHTML += '<p style="color: #dc3545;">⚠️ 本日の制限に近づいています</p>';
                }
            }
        };

        // レート制限
        const rateLimiter = {
            requests: [],
            
            canMakeRequest() {
                const now = Date.now();
                this.requests = this.requests.filter(time => now - time < SECURITY.rateLimitWindow);
                return this.requests.length < SECURITY.maxRequestsPerWindow;
            },
            
            recordRequest() {
                this.requests.push(Date.now());
            }
        };

        // トラブルシューティング情報表示
        function showTroubleshootingInfo(error) {
            const authStatus = document.getElementById('authStatus');
            const currentDomain = window.location.origin;
            
            const troubleshootingHTML = `
                <div class="status-message status-warning" style="margin-top: 15px;">
                    <h4>🔧 トラブルシューティング</h4>
                    <p><strong>現在のドメイン:</strong> ${currentDomain}</p>
                    <p><strong>よくある解決方法:</strong></p>
                    <ol style="margin: 10px 0; padding-left: 20px;">
                        <li><strong>config.js ファイルを確認:</strong><br>
                            - CLIENT_ID が正しく設定されているか<br>
                            - API_KEY が正しく設定されているか
                        </li>
                        <li><strong>Google Cloud Console の設定:</strong><br>
                            - 承認済みJavaScript生成元に <code>${currentDomain}</code> を追加<br>
                            - HTTPリファラー制限に <code>${currentDomain}/*</code> を追加
                        </li>
                        <li><strong>API の有効化:</strong><br>
                            - Google Calendar API が有効になっているか<br>
                            - Google Sheets API が有効になっているか
                        </li>
                        <li><strong>ブラウザのキャッシュをクリア</strong></li>
                    </ol>
                    <p style="margin-top: 10px;">
                        <a href="https://console.cloud.google.com/apis/credentials" target="_blank" style="color: #007bff;">
                            🔗 Google Cloud Console で設定を確認
                        </a>
                    </p>
                </div>
            `;
            
            authStatus.innerHTML += troubleshootingHTML;
        }

        // 設定チェック
        function checkConfig() {
            const configDiv = document.getElementById('configStatus');
            
            if (!window.APP_CONFIG) {
                configDiv.innerHTML = `
                    <div class="status-message status-error">
                        ❌ config.js ファイルが見つかりません<br>
                        <small>同じフォルダに config.js ファイルを作成してください</small>
                    </div>
                `;
                return false;
            }
            
            const config = window.APP_CONFIG;
            const issues = [];
            
            if (!config.CLIENT_ID || config.CLIENT_ID === 'あなたのクライアントID') {
                issues.push('CLIENT_ID が設定されていません');
            }
            
            if (!config.API_KEY || config.API_KEY === 'あなたのAPIキー') {
                issues.push('API_KEY が設定されていません');
            }
            
            if (!config.SPREADSHEET_ID) {
                issues.push('SPREADSHEET_ID が設定されていません');
            }
            
            // フォーマットチェック
            if (config.CLIENT_ID && !config.CLIENT_ID.includes('.apps.googleusercontent.com')) {
                issues.push('CLIENT_ID の形式が正しくありません');
            }
            
            if (config.API_KEY && !config.API_KEY.startsWith('AIza')) {
                issues.push('API_KEY の形式が正しくありません');
            }
            
            if (issues.length > 0) {
                configDiv.innerHTML = `
                    <div class="status-message status-error">
                        ❌ 設定に問題があります:<br>
                        ${issues.map(issue => `• ${issue}`).join('<br>')}
                        <br><br>
                        <strong>config.js の正しい例:</strong>
                        <pre style="background: #f8f9fa; padding: 10px; border-radius: 5px; margin: 10px 0; font-size: 0.9em;">
window.APP_CONFIG = {
    CLIENT_ID: '123456789-xxxxx.apps.googleusercontent.com',
    API_KEY: 'AIzaSyDxxxxxxxxxxxxxxxxxxxxxxxxxxxxx',
    SPREADSHEET_ID: '1RUYuKXKIKqMZ7M6B9cJnRHEsoAGqx1tkqXgBvK8jzLk'
};
                        </pre>
                    </div>
                `;
                return false;
            }
            
            APP_CONFIG = config;
            configDiv.innerHTML = `
                <div class="status-message status-success">
                    ✅ 設定ファイルが正常に読み込まれました<br>
                    <small>Client ID: ${config.CLIENT_ID.substring(0, 15)}...</small><br>
                    <small>API Key: ${config.API_KEY.substring(0, 15)}...</small>
                </div>
            `;
            return true;
        }

        // ファイル検証
        function validateFile(file) {
            if (!file) return { valid: false, error: 'ファイルが選択されていません' };
            
            if (file.size > SECURITY.maxFileSize) {
                return { valid: false, error: 'ファイルサイズが大きすぎます（最大10MB）' };
            }
            
            if (!SECURITY.allowedImageTypes.includes(file.type)) {
                return { valid: false, error: '対応していないファイル形式です（JPEG, PNGのみ）' };
            }
            
            return { valid: true };
        }

        // CSVデータ（埋め込み）
        const csvData = `Subject,曜日,開始時刻,終了時刻
読書タイム,月,8:10,8:25
1時間目,月,8:40,9:25
2時間目,月,9:30,10:15
中休み,月,10:15,10:35
3時間目,月,10:35,11:20
4時間目,月,11:25,12:10
給食,月,12:10,12:50
昼休み,月,12:50,13:20
5時間目,月,13:25,14:10
6時間目,月,14:15,15:00
帰りの会,月,15:00,15:15
職員会議・ケース会議,月,15:30,16:40
学び子（算数）,火,8:10,8:25
1時間目,火,8:40,9:25
2時間目,火,9:30,10:15
中休み,火,10:15,10:35
3時間目,火,10:35,11:20
4時間目,火,11:25,12:10
給食,火,12:10,12:50
昼休み,火,12:50,13:20
清掃,火,13:25,13:45
5時間目,火,13:45,14:30
6時間目,火,14:35,15:20
帰りの会,火,15:20,15:35
学年会,火,16:00,16:40
フッ化物洗口,水,8:10,8:25
1時間目,水,8:40,9:25
2時間目,水,9:30,10:15
中休み,水,10:15,10:35
3時間目,水,10:35,11:20
4時間目,水,11:25,12:10
給食,水,12:10,12:50
昼休み,水,12:50,13:20
清掃,水,13:25,13:45
5時間目,水,13:45,14:30
帰りの会,水,14:30,14:45
校内研修,水,15:15,16:40
全校タイム,木,8:10,8:25
1時間目,木,8:40,9:25
2時間目,木,9:30,10:15
中休み,木,10:15,10:35
3時間目,木,10:35,11:20
4時間目,木,11:25,12:10
給食,木,12:10,12:50
昼休み,木,12:50,13:20
清掃,木,13:25,13:45
5時間目,木,13:45,14:30
6時間目,木,14:35,15:20
帰りの会,木,15:20,15:35
チャレンジ,木,15:50,16:40
1年生,金,8:10,8:25
1時間目,金,8:40,9:25
2時間目,金,9:30,10:15
中休み,金,10:15,10:35
3時間目,金,10:35,11:20
4時間目,金,11:25,12:10
給食,金,12:10,12:50
昼休み,金,12:50,13:20
清掃,金,13:25,13:45
5時間目,金,13:45,14:30
6時間目,金,14:35,15:20
帰りの会,金,15:20,15:35
外部講師,金,15:35,17:05`;

        // 時程表データの解析
        function loadTimeSlots() {
            try {
                const lines = csvData.trim().split('\n');
                const headers = lines[0].split(',');
                
                timeSlots = lines.slice(1).map(line => {
                    const values = line.split(',');
                    const obj = {};
                    headers.forEach((header, index) => {
                        obj[header] = values[index];
                    });
                    return obj;
                });
                
                console.log('時程表データを読み込みました:', timeSlots);
                showStatus('📚 時程表データを読み込み完了', 'success');
                return true;
            } catch (error) {
                console.error('時程表データの読み込みエラー:', error);
                showStatus('時程表データの読み込みに失敗しました', 'error');
                return false;
            }
        }

        // Google API初期化（新しいGISライブラリ使用）
        async function initializeGapi() {
            if (!APP_CONFIG) {
                showAuthStatus('❌ 設定ファイルを読み込んでください', 'error');
                return;
            }

            try {
                showAuthStatus('🔄 Google APIを初期化中...', 'info');
                
                // 1. GAPI Client初期化
                await new Promise((resolve, reject) => {
                    gapi.load('client', {
                        callback: resolve,
                        onerror: () => reject(new Error('GAPI クライアントライブラリの読み込みに失敗'))
                    });
                });

                // 2. API Client設定
                await gapi.client.init({
                    apiKey: APP_CONFIG.API_KEY,
                    discoveryDocs: [
                        'https://www.googleapis.com/discovery/v1/apis/calendar/v3/rest',
                        'https://sheets.googleapis.com/$discovery/rest?version=v4'
                    ]
                });

                console.log('GAPI Client初期化完了');

                // 3. Google Identity Services (GIS) Token Client初期化
                tokenClient = google.accounts.oauth2.initTokenClient({
                    client_id: APP_CONFIG.CLIENT_ID,
                    scope: 'https://www.googleapis.com/auth/calendar https://www.googleapis.com/auth/spreadsheets',
                    callback: (response) => {
                        if (response.error) {
                            console.error('認証エラー:', response.error);
                            showAuthStatus('❌ 認証に失敗しました', 'error');
                            isSignedIn = false;
                        } else {
                            console.log('認証成功:', response);
                            accessToken = response.access_token;
                            gapi.client.setToken({access_token: accessToken});
                            isSignedIn = true;
                            showAuthStatus('✅ Google認証が完了しました', 'success');
                        }
                        updateAuthStatus();
                    }
                });

                console.log('Google Identity Services初期化完了');
                showAuthStatus('✅ Google API初期化完了。サインインしてください。', 'success');
                updateAuthStatus();
                
            } catch (error) {
                console.error('Google API初期化エラー:', error);
                
                let errorMessage = '❌ Google API初期化に失敗しました: ';
                
                if (error.message.includes('API key')) {
                    errorMessage += 'APIキーが無効です。';
                } else if (error.message.includes('Client ID')) {
                    errorMessage += 'クライアントIDが無効です。';
                } else if (error.message.includes('origin')) {
                    errorMessage += 'ドメインが許可リストに登録されていません。';
                } else {
                    errorMessage += error.message;
                }
                
                showAuthStatus(errorMessage, 'error');
                showTroubleshootingInfo(error);
            }
        }

        // 認証状態更新（新しいGIS対応）
        function updateAuthStatus() {
            const authorizeBtn = document.getElementById('authorizeBtn');
            const usageStatsDiv = document.getElementById('usageStats');
            
            if (isSignedIn && accessToken) {
                authorizeBtn.textContent = `✅ サインイン済み`;
                authorizeBtn.disabled = true;
                showAuthStatus('✅ Google認証が完了しました。', 'success');
                
                usageStatsDiv.classList.remove('hidden');
                usageTracker.updateStatsDisplay();
            } else {
                authorizeBtn.textContent = '🔓 Googleアカウントでサインイン';
                authorizeBtn.disabled = false;
                showAuthStatus('⚠️ Google認証が必要です', 'info');
                usageStatsDiv.classList.add('hidden');
            }
            
            checkFormCompletion();
        }

        // サインイン処理（新しいGIS使用）
        function signIn() {
            if (!tokenClient) {
                showAuthStatus('❌ 認証システムが初期化されていません', 'error');
                return;
            }

            try {
                // 既存のトークンをクリア
                if (accessToken) {
                    google.accounts.oauth2.revoke(accessToken, () => {
                        console.log('既存のトークンを取り消しました');
                    });
                }
                
                // 新しい認証を開始
                tokenClient.requestAccessToken({prompt: 'consent'});
            } catch (error) {
                console.error('サインインエラー:', error);
                showAuthStatus('❌ サインインに失敗しました', 'error');
            }
        }

        // サインアウト処理
        function signOut() {
            if (accessToken) {
                google.accounts.oauth2.revoke(accessToken, () => {
                    console.log('トークンを取り消しました');
                });
                gapi.client.setToken(null);
                accessToken = null;
                isSignedIn = false;
                updateAuthStatus();
                showAuthStatus('✅ サインアウトしました', 'info');
            }
        }

        // ファイルアップロード処理
        document.getElementById('imageFile').addEventListener('change', function(e) {
            const file = e.target.files[0];
            const label = document.getElementById('fileLabel');
            const previewArea = document.getElementById('previewArea');

            if (file) {
                const validation = validateFile(file);
                if (!validation.valid) {
                    showStatus(`❌ ${validation.error}`, 'error');
                    this.value = '';
                    return;
                }

                label.textContent = `✅ ${file.name} (${(file.size / 1024 / 1024).toFixed(1)}MB)`;
                label.classList.add('has-file');
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    previewArea.innerHTML = `<img src="${e.target.result}" class="preview-image" alt="週案プレビュー">`;
                };
                reader.onerror = function() {
                    showStatus('❌ 画像の読み込みに失敗しました', 'error');
                };
                reader.readAsDataURL(file);
                
                checkFormCompletion();
                showStatus('✅ 画像が正常にアップロードされました', 'success');
            } else {
                label.textContent = '📁 週案画像を選択してください';
                label.classList.remove('has-file');
                previewArea.innerHTML = '<p style="color: #666;">画像をアップロードするとここにプレビューが表示されます</p>';
                checkFormCompletion();
            }
        });

        // ステータスメッセージ表示
        function showStatus(message, type = 'info') {
            const statusArea = document.getElementById('statusArea');
            statusArea.innerHTML = `<div class="status-message status-${type}">${message}</div>`;
        }

        // 画像解析（模擬実装）
        async function analyzeScheduleImage(imageFile) {
            showStatus('🔍 画像を解析中...', 'info');
            
            const mockSchedule = {
                '月': {
                    '1時間目': '国語',
                    '2時間目': '算数',
                    '3時間目': '総合',
                    '4時間目': '理科',
                    '5時間目': '図工',
                    '6時間目': '図工'
                },
                '火': {
                    '1時間目': '算数',
                    '2時間目': '国語',
                    '3時間目': '社会',
                    '4時間目': '体育',
                    '5時間目': '理科',
                    '6時間目': '委員会活動'
                },
                '水': {
                    '1時間目': '特活',
                    '2時間目': '国語',
                    '3時間目': '算数',
                    '4時間目': '外国語',
                    '5時間目': '社会'
                },
                '木': {
                    '1時間目': '算数',
                    '2時間目': '書写',
                    '3時間目': '社会',
                    '4時間目': '外国語（ALT）',
                    '5時間目': '音楽',
                    '6時間目': '総合'
                },
                '金': {
                    '1時間目': '国語',
                    '2時間目': '算数',
                    '3時間目': '家庭',
                    '4時間目': '理科',
                    '5時間目': '総合',
                    '6時間目': '総合'
                }
            };

            await new Promise(resolve => setTimeout(resolve, 2000));
            return mockSchedule;
        }

        // 時間を24時間形式に変換
        function parseTime(timeStr) {
            const [hours, minutes] = timeStr.split(':').map(Number);
            return { hours, minutes };
        }

        // 日付と時刻からDateオブジェクトを作成
        function createDateTime(baseDate, timeStr) {
            const { hours, minutes } = parseTime(timeStr);
            const date = new Date(baseDate);
            date.setHours(hours, minutes, 0, 0);
            return date;
        }

        // Googleカレンダーイベント作成
        async function createCalendarEvent(title, startDate, endDate, description = '') {
            try {
                const event = {
                    summary: title,
                    start: {
                        dateTime: startDate.toISOString(),
                        timeZone: 'Asia/Tokyo'
                    },
                    end: {
                        dateTime: endDate.toISOString(),
                        timeZone: 'Asia/Tokyo'
                    },
                    description: description
                };

                const response = await gapi.client.calendar.events.insert({
                    calendarId: 'primary',
                    resource: event
                });

                return response.result;
            } catch (error) {
                console.error('イベント作成エラー:', error);
                throw error;
            }
        }

        // スプレッドシート更新
        async function updateSpreadsheet(scheduleData, startDate) {
            try {
                showStatus('📊 スプレッドシートを更新中...', 'info');
                
                // 教科別時間数を集計
                const subjectCounts = {};
                const days = ['月', '火', '水', '木', '金'];
                
                days.forEach(day => {
                    if (scheduleData[day]) {
                        Object.values(scheduleData[day]).forEach(subject => {
                            if (subject && subject !== '－') {
                                subjectCounts[subject] = (subjectCounts[subject] || 0) + 1;
                            }
                        });
                    }
                });

                console.log('教科別時間数:', subjectCounts);

                // データシートに時間数を記録
                const dataValues = [];
                Object.entries(subjectCounts).forEach(([subject, count]) => {
                    dataValues.push([new Date().toISOString().split('T')[0], subject, count]);
                });

                if (dataValues.length > 0) {
                    await gapi.client.sheets.spreadsheets.values.append({
                        spreadsheetId: APP_CONFIG.SPREADSHEET_ID,
                        range: 'データ!A:C',
                        valueInputOption: 'RAW',
                        resource: {
                            values: dataValues
                        }
                    });
                }

                // 週案シートに週案データを記録
                const monday = new Date(startDate);
                const weekValues = [];
                
                // ヘッダー行（日付）
                const dateRow = ['時間'];
                for (let i = 0; i < 5; i++) {
                    const date = new Date(monday);
                    date.setDate(monday.getDate() + i);
                    dateRow.push(`${date.getMonth() + 1}/${date.getDate()}(${days[i]})`);
                }
                weekValues.push(dateRow);

                // 各時間目のデータ
                const periods = ['1時間目', '2時間目', '3時間目', '4時間目', '5時間目', '6時間目'];
                periods.forEach(period => {
                    const row = [period];
                    days.forEach(day => {
                        const subject = scheduleData[day] && scheduleData[day][period] ? scheduleData[day][period] : '';
                        row.push(subject);
                    });
                    weekValues.push(row);
                });

                // 週案シートを更新
                await gapi.client.sheets.spreadsheets.values.update({
                    spreadsheetId: APP_CONFIG.SPREADSHEET_ID,
                    range: '週案!A1:F7',
                    valueInputOption: 'RAW',
                    resource: {
                        values: weekValues
                    }
                });

                console.log('スプレッドシート更新完了');
                return subjectCounts;
            } catch (error) {
                console.error('スプレッドシート更新エラー:', error);
                throw error;
            }
        }

        // カレンダーイベント作成
        async function createCalendarEvents(scheduleData, startDateStr) {
            const events = [];
            const startDate = new Date(startDateStr);
            const days = ['月', '火', '水', '木', '金'];
            
            for (let dayIndex = 0; dayIndex < days.length; dayIndex++) {
                const day = days[dayIndex];
                const currentDate = new Date(startDate);
                currentDate.setDate(startDate.getDate() + dayIndex);
                
                if (scheduleData[day]) {
                    const dayTimeSlots = timeSlots.filter(slot => slot.曜日 === day);
                    
                    for (const [period, subject] of Object.entries(scheduleData[day])) {
                        if (subject && subject !== '－') {
                            const timeSlot = dayTimeSlots.find(slot => slot.Subject === period);
                            
                            if (timeSlot) {
                                const startTime = createDateTime(currentDate, timeSlot.開始時刻);
                                const endTime = createDateTime(currentDate, timeSlot.終了時刻);
                                
                                try {
                                    const event = await createCalendarEvent(
                                        subject,
                                        startTime,
                                        endTime,
                                        `${day}曜日 ${period}`
                                    );
                                    events.push(event);
                                    
                                    // API制限を避けるための待機
                                    await new Promise(resolve => setTimeout(resolve, 100));
                                } catch (error) {
                                    console.error(`イベント作成失敗: ${subject}`, error);
                                }
                            }
                        }
                    }
                }
            }
            
            console.log(`${events.length}件のイベントを作成しました`);
            return events;
        }

        // 処理実行
        document.getElementById('processBtn').addEventListener('click', async function() {
            const imageFileInput = document.getElementById('imageFile');
            const imageFile = imageFileInput.files[0];

            // セキュリティチェック
            if (!isSignedIn) {
                showStatus('❌ Googleアカウントでサインインしてください', 'error');
                return;
            }

            if (!usageTracker.checkLimit()) {
                showStatus('❌ 本日の処理回数制限に達しました。明日再度お試しください。', 'error');
                return;
            }

            if (!rateLimiter.canMakeRequest()) {
                showStatus('❌ 処理が集中しています。1分後に再度お試しください。', 'error');
                return;
            }

            const validation = validateFile(imageFile);
            if (!validation.valid) {
                showStatus(`❌ ${validation.error}`, 'error');
                return;
            }

            if (!timeSlots || timeSlots.length === 0) {
                showStatus('❌ 時程表データが読み込まれていません', 'error');
                return;
            }

            try {
                // レート制限記録
                rateLimiter.recordRequest();
                
                this.innerHTML = '<span class="loading"></span>処理中...';
                this.disabled = true;

                // 1. 画像解析
                scheduleData = await analyzeScheduleImage(imageFile);
                
                // 2. 解析結果表示
                displaySchedulePreview(scheduleData);
                
                // 3. カレンダーイベント作成
                const today = new Date();
                const monday = new Date(today);
                const day = today.getDay();
                const diff = today.getDate() - day + (day === 0 ? -6 : 1);
                monday.setDate(diff);
                const startDateStr = monday.toISOString().split('T')[0];
                
                showStatus('📅 Googleカレンダーに予定を追加中...', 'info');
                const events = await createCalendarEvents(scheduleData, startDateStr);
                
                // 4. スプレッドシート更新
                const subjectCounts = await updateSpreadsheet(scheduleData, startDateStr);
                
                // 使用量を記録
                usageTracker.incrementUsage();
                
                showStatus(`✅ 処理が完了しました！ ${events.length}件のイベントを作成し、スプレッドシートを更新しました。`, 'success');
                
            } catch (error) {
                console.error('処理エラー:', error);
                
                let errorMessage = '処理中にエラーが発生しました。';
                if (error.status === 403) {
                    errorMessage = 'Google APIの権限が不足しています。管理者にお問い合わせください。';
                } else if (error.status === 429) {
                    errorMessage = 'APIの使用量制限に達しました。しばらく時間をおいて再度お試しください。';
                } else if (error.status === 401) {
                    errorMessage = '認証が無効になりました。再度サインインしてください。';
                }
                
                showStatus(`❌ ${errorMessage}`, 'error');
            } finally {
                this.innerHTML = '📅 カレンダーとスプレッドシートを更新';
                this.disabled = false;
            }
        });

        // フォーム完了チェック
        function checkFormCompletion() {
            const imageFile = document.getElementById('imageFile').files[0];
            const processBtn = document.getElementById('processBtn');

            const hasValidFile = imageFile && validateFile(imageFile).valid;
            const isComplete = hasValidFile && timeSlots && timeSlots.length > 0 && isSignedIn && APP_CONFIG;
            processBtn.disabled = !isComplete;

            console.log('フォーム完了チェック:', {
                hasValidFile: hasValidFile,
                timeSlots: !!(timeSlots && timeSlots.length > 0),
                isSignedIn: isSignedIn,
                hasConfig: !!APP_CONFIG,
                isComplete: isComplete
            });
        }

        // 解析結果表示
        function displaySchedulePreview(scheduleData) {
            const resultsSection = document.getElementById('resultsSection');
            const schedulePreview = document.getElementById('schedulePreview');
            
            const days = ['月', '火', '水', '木', '金'];
            const dayNames = ['月曜日', '火曜日', '水曜日', '木曜日', '金曜日'];
            
            schedulePreview.innerHTML = '';
            
            days.forEach((day, index) => {
                const dayColumn = document.createElement('div');
                dayColumn.className = 'day-column';
                
                const dayHeader = document.createElement('div');
                dayHeader.className = 'day-header';
                dayHeader.textContent = dayNames[index];
                dayColumn.appendChild(dayHeader);
                
                if (scheduleData[day]) {
                    Object.entries(scheduleData[day]).forEach(([period, subject]) => {
                        const periodItem = document.createElement('div');
                        periodItem.className = 'period-item';
                        periodItem.innerHTML = `<strong>${period}:</strong> ${subject || '－'}`;
                        dayColumn.appendChild(periodItem);
                    });
                } else {
                    const noData = document.createElement('div');
                    noData.className = 'period-item';
                    noData.style.color = '#999';
                    noData.textContent = 'データなし';
                    dayColumn.appendChild(noData);
                }
                
                schedulePreview.appendChild(dayColumn);
            });
            
            resultsSection.classList.remove('hidden');
        }

        // ページ読み込み時の初期化
        document.addEventListener('DOMContentLoaded', function() {
            console.log('アプリケーション初期化開始');
            
            // 1. 設定チェック
            if (!checkConfig()) {
                console.log('設定チェック失敗');
                return;
            }
            console.log('設定チェック完了');
            
            // 2. 時程表データを読み込み
            if (!loadTimeSlots()) {
                console.log('時程表データ読み込み失敗');
                return;
            }
            console.log('時程表データ読み込み完了');
            
            // 3. Google API初期化（GAPIとGISライブラリの読み込み完了を待つ）
            setTimeout(() => {
                if (typeof gapi !== 'undefined' && typeof google !== 'undefined' && google.accounts) {
                    console.log('Google API初期化開始');
                    initializeGapi();
                } else {
                    console.error('Google API ライブラリが読み込まれていません');
                    showAuthStatus('❌ Google API ライブラリの読み込みに失敗しました。ページを再読み込みしてください。', 'error');
                }
            }, 1000);
            
            // 4. 初期状態でフォーム完了チェック
            setTimeout(checkFormCompletion, 1500);
        });

        // イベントリスナー
        document.getElementById('authorizeBtn').addEventListener('click', signIn);
        document.getElementById('signOutBtn').addEventListener('click', signOut);

        // エラーハンドリング
        window.addEventListener('error', function(e) {
            console.error('グローバルエラー:', e.error);
            showStatus('❌ 予期しないエラーが発生しました。ページを再読み込みしてください。', 'error');
        });

        // セキュリティヘッダー確認（開発時のみ）
        if (window.location.protocol !== 'https:' && window.location.hostname !== 'localhost') {
            console.warn('⚠️ HTTPS接続を推奨します');
        }
    </script>
</body>
</html>
